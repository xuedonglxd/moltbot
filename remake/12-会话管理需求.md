# 12 - 会话管理需求

> **版本**: v1.0
> **最后更新**: 2026-01-29
> **依赖文档**: 11-消息路由系统需求
> **后续文档**: 13-会话压缩需求, 14-Agent基础架构需求

---

## 1. 需求概述

### 1.1 目标描述

实现**会话存储和管理系统**，负责持久化对话历史、会话元数据、Token 使用统计等信息，支持会话的创建、加载、更新和删除。

**核心目标:**
- **历史持久化**: 对话历史以 JSONL 格式存储
- **元数据管理**: 会话元数据缓存在内存和磁盘
- **事务安全**: 支持并发读写，保证数据一致性
- **高性能**: 快速读取和写入

### 1.2 业务场景

#### 场景 1: 创建新会话
**触发**: 用户首次与 Agent 对话。

**流程**:
```
1. 生成 Session ID（UUID）
2. 创建会话条目（SessionEntry）
3. 保存到会话存储（sessions.json）
4. 创建历史文件（<sessionId>.jsonl）
```

#### 场景 2: 加载会话历史
**触发**: Agent 运行前需要加载历史。

**流程**:
```
1. 根据 Session Key 查找 Session ID
2. 读取历史文件（<sessionId>.jsonl）
3. 解析 JSONL 格式
4. 返回消息列表
```

#### 场景 3: 更新会话
**触发**: Agent 运行后更新 Token 使用统计。

**流程**:
```
1. 更新会话条目字段
2. 更新 updatedAt 时间戳
3. 保存到会话存储
```

---

## 2. 核心概念

### 2.1 会话条目(SessionEntry)

```typescript
interface SessionEntry {
  sessionKey: string;           // 会话键
  sessionId: string;            // 会话 ID（UUID）
  createdAt: string;            // 创建时间
  updatedAt: string;            // 更新时间
  inputTokens: number;          // 输入 Token 数
  outputTokens: number;         // 输出 Token 数
  totalTokens: number;          // 总 Token 数
  model?: string;               // 使用的模型
  provider?: string;            // 使用的提供商
  lastChannel?: string;         // 最后使用的渠道
  lastTo?: string;              // 最后发送到的目标
  lastFrom?: string;            // 最后的发送者
}
```

### 2.2 会话存储

**位置**: `~/.clawdbot/agents/<agentId>/sessions/`

**文件**:
- `sessions.json` - 会话元数据（Session Key → Session Entry 映射）
- `<sessionId>.jsonl` - 会话历史（JSONL 格式）

### 2.3 JSONL 格式

**定义**: 每行一个 JSON 对象，用于存储消息历史。

**示例**:
```jsonl
{"role":"user","content":"Hello"}
{"role":"assistant","content":"Hi! How can I help?"}
{"role":"user","content":"What's the weather?"}
```

**优点**:
- 追加写入高效
- 逐行解析，内存占用低
- 易于备份和恢复

---

## 3. 功能需求

### 3.1 核心功能列表

#### P0 功能

| 功能 ID | 功能名称 | 说明 |
|---------|---------|------|
| **F01** | 创建会话 | createSessionEntry() |
| **F02** | 加载会话存储 | loadSessionStore() |
| **F03** | 更新会话 | updateSessionEntry() |
| **F04** | 保存会话存储 | saveSessionStore() |
| **F05** | 加载历史 | loadTranscript() |
| **F06** | 追加历史 | appendToTranscript() |

#### P1 功能

| 功能 ID | 功能名称 | 说明 |
|---------|---------|------|
| **F07** | 删除会话 | deleteSession() |
| **F08** | 重置会话 | resetSession() |

---

## 4. 架构设计

### 4.1 接口定义

```typescript
// 会话存储接口
export interface SessionStore {
  [sessionKey: string]: SessionEntry;
}

// 加载会话存储
export function loadSessionStore(agentId: string): SessionStore {
  const storePath = resolveStorePath(agentId);
  if (!fs.existsSync(storePath)) return {};

  const raw = fs.readFileSync(storePath, 'utf-8');
  return JSON.parse(raw);
}

// 保存会话存储
export async function saveSessionStore(
  agentId: string,
  store: SessionStore
) {
  const storePath = resolveStorePath(agentId);
  const json = JSON.stringify(store, null, 2);
  await fs.promises.writeFile(storePath, json, 'utf-8');
}

// 更新会话条目
export function updateSessionEntry(
  store: SessionStore,
  sessionKey: string,
  updates: Partial<SessionEntry>
): SessionStore {
  const existing = store[sessionKey] ?? {
    sessionKey,
    sessionId: generateUUID(),
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    inputTokens: 0,
    outputTokens: 0,
    totalTokens: 0,
  };

  return {
    ...store,
    [sessionKey]: {
      ...existing,
      ...updates,
      updatedAt: new Date().toISOString(),
    }
  };
}
```

---

## 5. 关键实现

### 5.1 参考代码位置

| 功能 | Moltbot 代码位置 |
|------|-----------------|
| 会话存储 | `src/config/sessions/store.ts` |
| 会话管理 | `src/auto-reply/reply/session.ts` |

---

**文档完成** ✅
