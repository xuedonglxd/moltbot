# 33 - 模型回退与认证轮换需求

> **版本**: v1.0
> **最后更新**: 2026-01-29
> **依赖文档**: 15-LLM提供商集成需求
> **后续文档**: 34-Web UI需求

---

## 1. 需求概述

### 1.1 目标描述

实现**模型失败自动回退**和**认证配置轮换**，提高系统可用性。

**核心目标:**
- **自动回退**: 主模型失败时切换备用模型
- **认证轮换**: 多个 API Key 轮换使用
- **健康检查**: 定期检测模型可用性

---

## 2. 回退策略

### 2.1 配置

```json5
{
  agents: {
    list: [
      {
        id: "main",
        model: "anthropic/claude-sonnet-4-5",
        fallback: {
          models: [
            "anthropic/claude-sonnet-3-5",
            "openai/gpt-4"
          ],
          retryAttempts: 2
        }
      }
    ]
  }
}
```

### 2.2 回退逻辑

```typescript
export async function callLLMWithFallback(params: {
  model: string;
  fallbackModels: string[];
  messages: Message[];
}): Promise<Response> {
  const models = [params.model, ...params.fallbackModels];

  for (const model of models) {
    try {
      return await callLLM({ model, messages: params.messages });
    } catch (err) {
      console.warn(`Model ${model} failed:`, err);
      continue;
    }
  }

  throw new Error('All models failed');
}
```

---

## 3. 认证轮换

### 3.1 认证池

```json5
{
  auth: {
    profiles: {
      "anthropic-1": { provider: "anthropic", mode: "api_key" },
      "anthropic-2": { provider: "anthropic", mode: "api_key" }
    },
    order: {
      "anthropic": ["anthropic-1", "anthropic-2"]
    }
  }
}
```

### 3.2 轮换逻辑

```typescript
export function getNextApiKey(provider: string): string {
  const order = config.auth.order[provider];
  const currentIndex = getCurrentIndex(provider);
  const nextIndex = (currentIndex + 1) % order.length;

  setCurrentIndex(provider, nextIndex);
  return getApiKey(order[nextIndex]);
}
```

---

**文档完成** ✅
