# 10 - 其他主流渠道需求

> **版本**: v1.0
> **最后更新**: 2026-01-29
> **依赖文档**: 07-渠道抽象层需求, 08-WhatsApp渠道需求, 09-Telegram渠道需求
> **后续文档**: 11-消息路由系统需求

---

## 1. 需求概述

### 1.1 目标描述

实现 **Discord、Slack、Signal、iMessage** 等其他主流消息渠道，每个渠道根据其特点选择合适的技术实现方式。本文档统一说明这些渠道的实现要点，避免重复。

**实现模式参考**:
- **Bot API 类**（Discord、Slack）: 参考 Telegram 实现模式（文档 09）
- **进程通信类**（Signal）: 通过 CLI 进程通信
- **系统集成类**（iMessage）: 通过系统 API 或第三方服务

---

## 2. 各渠道实现要点

### 2.1 Discord 渠道

**技术栈**: Carbon 库（Discord API 封装）

**认证方式**: Bot Token

**核心功能**:
- Guild/Channel 管理
- 消息收发
- Embed 消息
- Slash Commands

**实现要点**:
```typescript
import { Client } from '@buape/carbon';

export async function startDiscordChannel(cfg: MoltbotConfig) {
  const token = cfg.channels?.discord?.token;
  const client = new Client({ token });

  client.on('messageCreate', async (message) => {
    await processMessage({
      channel: 'discord',
      messageId: message.id,
      from: message.author.id,
      text: message.content,
      guildId: message.guildId,
      // ...
    }, cfg);
  });

  await client.login();
  return { stop: () => client.destroy() };
}
```

**参考代码**: `src/discord/`

---

### 2.2 Slack 渠道

**技术栈**: Bolt SDK（Slack 官方 SDK）

**认证方式**: OAuth 或 Bot Token

**核心功能**:
- Workspace/Channel 管理
- Socket Mode（WebSocket 连接）
- 线程支持
- Slash Commands
- Interactive Components

**实现要点**:
```typescript
import { App } from '@slack/bolt';

export async function startSlackChannel(cfg: MoltbotConfig) {
  const app = new App({
    token: cfg.channels?.slack?.botToken,
    appToken: cfg.channels?.slack?.appToken,
    socketMode: true,
  });

  app.message(async ({ message, say }) => {
    await processMessage({
      channel: 'slack',
      messageId: message.ts,
      from: message.user,
      text: message.text,
      teamId: message.team,
      // ...
    }, cfg);
  });

  await app.start();
  return { stop: () => app.stop() };
}
```

**参考代码**: `src/slack/`

---

### 2.3 Signal 渠道

**技术栈**: signal-cli（Signal 的命令行接口）

**认证方式**: 电话号码注册

**核心功能**:
- 消息收发
- 群组支持
- 媒体支持

**实现要点**:
```typescript
import { spawn } from 'child_process';

export async function startSignalChannel(cfg: MoltbotConfig) {
  // 启动 signal-cli daemon
  const proc = spawn('signal-cli', [
    '--config', '~/.clawdbot/signal-config',
    'daemon',
    '--json'
  ]);

  // 解析 JSON 输出
  proc.stdout.on('data', (data) => {
    const lines = data.toString().split('\n');
    for (const line of lines) {
      if (!line.trim()) continue;
      const event = JSON.parse(line);

      if (event.envelope) {
        processMessage({
          channel: 'signal',
          messageId: String(event.envelope.timestamp),
          from: event.envelope.source,
          text: event.envelope.dataMessage?.message,
          // ...
        }, cfg);
      }
    }
  });

  return { stop: () => proc.kill() };
}
```

**参考代码**: `src/signal/`

---

### 2.4 iMessage 渠道

**技术栈**: BlueBubbles 或 AppleScript

**认证方式**: 无（使用本地 iMessage 账户）

**核心功能**:
- 消息收发
- 群组支持
- 媒体支持

**实现方式 1: BlueBubbles**（推荐）
```typescript
// 通过 BlueBubbles 服务器 API
export async function startIMessageChannel(cfg: MoltbotConfig) {
  const apiUrl = cfg.channels?.imessage?.blueBubblesUrl;
  const password = cfg.channels?.imessage?.blueBubblesPassword;

  // WebSocket 连接到 BlueBubbles
  const ws = new WebSocket(`${apiUrl}/socket.io/`);

  ws.on('message', (data) => {
    const event = JSON.parse(data);
    if (event.type === 'new-message') {
      processMessage({
        channel: 'imessage',
        messageId: event.data.guid,
        from: event.data.handle,
        text: event.data.text,
        // ...
      }, cfg);
    }
  });

  return { stop: () => ws.close() };
}
```

**实现方式 2: AppleScript**（备选）
```typescript
// 通过 AppleScript 发送消息
import { exec } from 'child_process';

export async function sendMessageIMessage(params: {
  to: string;
  text: string;
}) {
  const script = `
    tell application "Messages"
      send "${params.text}" to buddy "${params.to}"
    end tell
  `;

  await execAppleScript(script);
}
```

**参考代码**: `src/imessage/`, `extensions/bluebubbles/`

---

## 3. 渠道对比

| 渠道 | 认证方式 | 实现难度 | 技术栈 | 官方 API |
|------|---------|---------|--------|---------|
| WhatsApp | 二维码 | ⭐⭐⭐⭐⭐ | Baileys | ❌ |
| Telegram | Bot Token | ⭐⭐ | Grammy | ✅ |
| Discord | Bot Token | ⭐⭐⭐ | Carbon | ✅ |
| Slack | OAuth/Token | ⭐⭐⭐ | Bolt SDK | ✅ |
| Signal | 电话号码 | ⭐⭐⭐⭐ | signal-cli | ✅ |
| iMessage | 本地账户 | ⭐⭐⭐⭐ | BlueBubbles/AppleScript | ❌ |

---

## 4. 实现策略

### 4.1 优先级

**P0（必须）**: WhatsApp、Telegram
**P1（重要）**: Discord、Slack
**P2（可选）**: Signal、iMessage

### 4.2 实现顺序

1. 先实现 Telegram（最简单，有完善的官方 API）
2. 再实现 WhatsApp（最复杂，验证抽象层设计）
3. 依次实现 Discord、Slack（参考 Telegram 模式）
4. 最后实现 Signal、iMessage（特殊实现方式）

---

**文档完成** ✅
