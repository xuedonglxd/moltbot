# Moltbot 需求文档架构

本文档系列旨在通过系统化的需求描述，帮助学习者按顺序实现一个类似 Moltbot 的个人 AI 助手系统，覆盖核心功能（约 80% 的系统能力）。

## 文档阅读顺序

### 第一阶段：核心基础设施（Foundation）

#### 01-配置系统需求
**实现目标：** 完成配置管理框架，支持多层级配置、验证和热重载
**功能覆盖：** 配置加载、JSON5 解析、Zod 验证、环境变量、配置迁移
**架构要求：** 模块化配置结构、类型安全、配置优先级

#### 02-CLI命令框架需求
**实现目标：** 构建命令行界面框架，支持命令注册和参数解析
**功能覆盖：** CLI 程序构建、Commander.js 集成、依赖注入、命令分类
**架构要求：** 可扩展的命令系统、统一的错误处理、进度显示

#### 03-依赖注入系统需求
**实现目标：** 实现依赖注入容器，管理服务生命周期
**功能覆盖：** 默认依赖创建、服务注册、依赖解析
**架构要求：** 松耦合、可测试性、单例管理

---

### 第二阶段：网关核心（Gateway Core）

#### 04-Gateway基础架构需求
**实现目标：** 实现 Gateway 服务器，作为系统的控制平面
**功能覆盖：** WebSocket 服务器、HTTP 服务器、TLS 支持、进程管理
**架构要求：** 单一长期运行进程、事件驱动、可扩展的处理器

#### 05-WebSocket协议需求
**实现目标：** 定义并实现 Gateway 与客户端的通信协议
**功能覆盖：** 请求/响应模式、事件推送、心跳检测、连接管理
**架构要求：** JSON-RPC 风格协议、版本化消息、错误处理

#### 06-插件系统需求
**实现目标：** 实现动态插件加载和生命周期管理
**功能覆盖：** 插件发现、动态加载（jiti）、插件元数据、插件 API
**架构要求：** 隔离性、热加载、版本兼容性

---

### 第三阶段：消息渠道（Messaging Channels - 3 个文档）

#### 07-渠道抽象层需求
**实现目标：** 定义统一的渠道接口和生命周期管理
**功能覆盖：** 渠道注册、启动/停止、状态管理、错误恢复、消息接收流程、消息去重
**架构要求：** 接口抽象、生命周期钩子、统一的消息格式、去重缓存机制

**重要说明：** 本章节包含完整的消息处理管道（接收→解析→去重→上下文构建），是连接渠道和路由的关键桥梁

#### 08-WhatsApp渠道需求
**实现目标：** 实现 WhatsApp 消息收发（基于 Baileys）
**功能覆盖：** 二维码认证、消息接收、消息发送、媒体处理、群组支持
**架构要求：** 会话持久化、多设备支持、断线重连

**代表性**：最复杂的 Web 协议渠道，无官方 API，需要完整的协议实现

#### 09-Telegram渠道需求
**实现目标：** 实现 Telegram Bot 集成（基于 Grammy）
**功能覆盖：** Bot Token 认证、消息接收、消息发送、命令处理、群组支持
**架构要求：** Webhook 模式、长轮询模式、媒体缓存

**代表性**：最典型的 Bot API 渠道，官方 API 支持完善，是其他 Bot 类渠道的参考实现

#### 10-其他主流渠道需求
**实现目标：** 实现 Discord、Slack、Signal、iMessage 等主流渠道的集成
**功能覆盖：** 各渠道特定的认证、消息收发、特殊功能（线程、Guild、进程通信等）
**架构要求：** 统一的渠道接口适配、各渠道特定的技术实现

**说明**：本章节统一说明其他主流渠道的实现要点，避免重复。各渠道的详细实现可参考 WhatsApp 和 Telegram 的模式

---

### 第四阶段：路由与会话（Routing & Sessions）

#### 11-消息路由系统需求
**实现目标：** 实现消息到 Agent 的路由逻辑
**功能覆盖：** 路由解析、Peer 匹配、Guild/Team 匹配、默认路由、绑定配置、Session Key 生成
**架构要求：** 优先级匹配、路由缓存、动态更新、确定性 Session Key 算法

**重要说明：** Session Key 格式为核心概念，决定了会话的隔离和持久化策略

#### 12-会话管理需求
**实现目标：** 实现对话上下文的存储和管理
**功能覆盖：** 会话创建、历史加载、会话更新、会话保存、Session Key 生成
**架构要求：** JSONL 格式、元数据缓存、事务安全

#### 13-会话压缩需求
**实现目标：** 实现上下文窗口管理和自动压缩
**功能覆盖：** Token 计数、上下文窗口守卫、历史总结、压缩策略
**架构要求：** 渐进式压缩、关键信息保留、可配置阈值

---

### 第五阶段：Agent 运行时（Agent Runtime）

#### 14-Agent基础架构需求
**实现目标：** 实现嵌入式 Agent 运行引擎
**功能覆盖：** Agent 创建、工作空间管理、指令加载、人格配置
**架构要求：** 隔离性、工作空间结构、指令系统

#### 15-LLM提供商集成需求
**实现目标：** 实现多 AI 提供商的统一接口
**功能覆盖：** Anthropic、OpenAI、Gemini、Bedrock 集成、OAuth 认证、API Key 管理
**架构要求：** 提供商抽象、认证轮换、模型回退

#### 16-Agent执行循环需求
**实现目标：** 实现 Agent 的主执行循环
**功能覆盖：** 消息处理、模型调用、工具调用、结果处理、错误恢复
**架构要求：** 异步执行、流式响应、超时控制

#### 17-上下文窗口管理需求
**实现目标：** 实现动态上下文窗口管理
**功能覆盖：** Token 计数、窗口守卫、自动压缩触发
**架构要求：** 实时监控、自适应压缩、提供商差异处理

---

### 第六阶段：工具系统（Tool System）

#### 18-工具抽象层需求
**实现目标：** 定义统一的工具接口和注册机制
**功能覆盖：** 工具定义、Schema 定义、工具注册、工具执行
**架构要求：** JSON Schema、类型安全、权限控制

#### 19-文件操作工具需求
**实现目标：** 实现文件读写编辑工具
**功能覆盖：** Read、Write、Edit、Glob、Grep
**架构要求：** 沙箱限制、路径验证、原子操作

#### 20-命令执行工具需求
**实现目标：** 实现 Shell 命令执行工具
**功能覆盖：** Bash/Zsh 执行、超时控制、输出捕获、后台运行
**架构要求：** 安全限制、工作目录管理、环境变量

#### 21-浏览器控制工具需求
**实现目标：** 实现浏览器自动化工具（基于 Playwright）
**功能覆盖：** CDP 连接、页面导航、元素交互、截图、页面内容提取
**架构要求：** 浏览器生命周期、会话管理、资源清理

#### 22-Sub-Agent生成工具需求
**实现目标：** 实现 Agent 间通信和子 Agent 生成
**功能覆盖：** Sessions Spawn、Sessions Send、Sessions List
**架构要求：** Agent 隔离、消息传递、生命周期管理

#### 23-Canvas工具需求
**实现目标：** 实现 Canvas UI 渲染和交互
**功能覆盖：** A2UI 集成、Canvas Host、事件处理
**架构要求：** WebView 嵌入、双向通信、状态同步

---

### 第七阶段：媒体处理（Media Pipeline）

#### 24-图像处理需求
**实现目标：** 实现图像缩放、格式转换和优化
**功能覆盖：** Sharp 集成、WebP 转换、尺寸调整、质量控制
**架构要求：** 流式处理、内存控制、格式支持

#### 25-OCR识别需求
**实现目标：** 实现图像文字识别
**功能覆盖：** Tesseract 集成、多语言支持、结果解析
**架构要求：** 语言包管理、精度配置、批处理

#### 26-音频转录需求
**实现目标：** 实现音频到文本的转录
**功能覆盖：** Whisper API 集成、格式转换、分段处理
**架构要求：** 流式上传、长音频分段、多语言支持

#### 27-视频处理需求
**实现目标：** 实现视频格式转换和关键帧提取
**功能覆盖：** FFmpeg 集成、格式转换、缩略图生成
**架构要求：** 进程管理、流式处理、资源限制

#### 28-PDF解析需求
**实现目标：** 实现 PDF 文本和图像提取
**功能覆盖：** PDF-lib 集成、文本提取、图像提取
**架构要求：** 页面分页、混合内容、格式保留

---

### 第八阶段：高级特性（Advanced Features）

#### 29-Cron定时任务需求
**实现目标：** 实现定时任务调度系统
**功能覆盖：** Cron 表达式、任务注册、执行日志、错误重试
**架构要求：** 时区支持、持久化、并发控制

#### 30-配置热重载需求
**实现目标：** 实现配置文件监听和热更新
**功能覆盖：** 文件监听（Chokidar）、增量更新、回滚机制
**架构要求：** 无损更新、验证优先、部分重启

#### 31-内存系统需求
**实现目标：** 实现长期记忆存储和检索
**功能覆盖：** 向量数据库集成（LanceDB）、语义搜索、记忆管理
**架构要求：** 嵌入生成、索引优化、隐私控制

#### 32-设备节点需求
**实现目标：** 实现移动设备作为能力节点
**功能覆盖：** 设备注册、能力发现、远程调用（相机、屏幕录制、位置）
**架构要求：** 节点协议、权限管理、设备发现

#### 33-模型回退与认证轮换需求
**实现目标：** 实现模型失败自动回退和认证配置轮换
**功能覆盖：** 回退策略、认证池、健康检查
**架构要求：** 优先级队列、熔断机制、透明切换

---

### 第九阶段：多平台应用（Multi-Platform Apps）

#### 34-macOS应用需求
**实现目标：** 实现 macOS 菜单栏应用
**功能覆盖：** SwiftUI UI、Gateway 控制、配置界面、Canvas Host
**架构要求：** Observation 框架、LaunchAgent 集成、权限管理

#### 35-iOS应用需求
**实现目标：** 实现 iOS 设备节点应用
**功能覆盖：** SwiftUI UI、WebSocket 连接、设备能力（相机、录屏）
**架构要求：** Background Mode、权限申请、通知支持

#### 36-Android应用需求
**实现目标：** 实现 Android 设备节点应用
**功能覆盖：** Compose UI、WebSocket 连接、设备能力（相机、录屏）
**架构要求：** Foreground Service、权限申请、通知支持

#### 37-Web控制台需求
**实现目标：** 实现 Web 控制界面
**功能覆盖：** Lit 组件、WebSocket 连接、聊天界面、配置界面
**架构要求：** Web Components、响应式设计、状态管理

---

### 第十阶段：集成与测试（Integration & Testing）

#### 38-单元测试框架需求
**实现目标：** 实现单元测试和覆盖率检查
**功能覆盖：** Vitest 集成、Mock 工具、覆盖率阈值
**架构要求：** 测试隔离、快照测试、异步测试

#### 39-E2E测试需求
**实现目标：** 实现端到端测试流程
**功能覆盖：** Docker 测试环境、完整流程测试、渠道集成测试
**架构要求：** 测试容器化、数据清理、并发控制

#### 40-Lint与格式化需求
**实现目标：** 实现代码质量检查和自动格式化
**功能覆盖：** Oxlint 集成、Oxfmt 集成、Pre-commit Hook
**架构要求：** 快速检查、自动修复、CI 集成

---

### 第十一阶段：部署与监控（Deployment & Monitoring）

#### 41-安装脚本需求
**实现目标：** 实现多平台安装脚本
**功能覆盖：** Shell 脚本（Linux/macOS）、PowerShell 脚本（Windows）、依赖检查
**架构要求：** 幂等性、错误恢复、版本检测

#### 42-更新系统需求
**实现目标：** 实现自动更新检查和安装
**功能覆盖：** 版本检查、自动下载、增量更新、回滚机制
**架构要求：** 安全验证、后台更新、无损升级

#### 43-日志系统需求
**实现目标：** 实现统一的日志收集和查询
**功能覆盖：** 结构化日志、日志级别、日志轮转、统一日志查询（macOS）
**架构要求：** 高性能、可搜索、隐私保护

#### 44-健康检查需求
**实现目标：** 实现系统健康检查和诊断
**功能覆盖：** Doctor 命令、配置验证、渠道探测、依赖检查
**架构要求：** 自动修复、诊断报告、配置迁移

#### 45-监控与告警需求
**实现目标：** 实现系统监控和异常告警
**功能覆盖：** 指标收集、性能监控、错误追踪、告警通知
**架构要求：** 低开销、实时监控、可配置告警

---

## 文档结构规范

每个需求文档包含以下部分：

### 1. 需求概述
- **目标描述**：该模块的核心目标
- **业务场景**：实际使用场景
- **用户价值**：为用户带来的价值

### 2. 功能需求
- **核心功能列表**：必须实现的功能
- **功能优先级**：P0（必须）、P1（重要）、P2（可选）
- **用户交互流程**：典型的使用流程

### 3. 非功能需求
- **性能要求**：响应时间、吞吐量
- **可靠性要求**：容错、恢复
- **安全性要求**：认证、授权、加密
- **可扩展性要求**：扩展点、插件支持

### 4. 架构约束
- **技术选型**：使用的技术栈和库
- **设计模式**：应用的设计模式
- **接口定义**：API 接口、数据结构
- **依赖关系**：依赖的其他模块

### 5. 实现指南
- **关键实现步骤**：实现的先后顺序
- **技术难点**：需要注意的难点
- **测试策略**：如何测试该模块
- **参考代码位置**：Moltbot 中的对应代码

### 6. 验收标准
- **功能验收**：功能完整性检查
- **性能验收**：性能指标达标
- **测试覆盖**：测试覆盖率要求

---

## 实现路径图

```
阶段 1-3 (01-10)：基础设施 + 网关 + 渠道
    ↓
    完成后可以：发送和接收消息、管理渠道配置

阶段 4-5 (11-17)：路由 + Agent 运行时
    ↓
    完成后可以：将消息路由到 Agent、执行 AI 对话

阶段 6-7 (18-28)：工具系统 + 媒体处理
    ↓
    完成后可以：使用工具（文件、浏览器等）、处理媒体

阶段 8 (29-33)：高级特性
    ↓
    完成后可以：定时任务、热重载、长期记忆

阶段 9 (34-37)：多平台应用
    ↓
    完成后可以：使用原生 App 控制系统

阶段 10-11 (38-45)：测试 + 部署
    ↓
    完成后可以：质量保障、生产部署
```

---

## 文档维护

- **版本控制**：每个文档包含版本号和修订历史
- **交叉引用**：文档间相互引用使用明确的文档编号
- **更新频率**：根据实现进度更新
- **反馈机制**：实现过程中发现的问题反馈到文档

---

## 使用建议

1. **按顺序实现**：严格按照文档编号顺序实现，确保依赖关系正确
2. **边实现边测试**：每完成一个模块，立即编写和运行测试
3. **代码审查**：对照架构约束进行自我审查
4. **记录偏差**：实现过程中的设计偏差记录下来，便于后续调整
5. **渐进式集成**：每完成一个阶段，进行一次完整的集成测试

---

## 附录

### A. 技术栈清单
- **语言**：TypeScript (ESM)
- **运行时**：Node ≥22, Bun (可选)
- **测试**：Vitest
- **Lint/Format**：Oxlint, Oxfmt
- **CLI**：Commander.js
- **Web**：Hono, ws
- **UI**：SwiftUI (macOS/iOS), Compose (Android), Lit (Web)

### B. 核心依赖库
- `@mariozechner/pi-agent-core` - Agent 核心
- `@whiskeysockets/baileys` - WhatsApp
- `grammy` - Telegram
- `@slack/bolt` - Slack
- `@buape/carbon` - Discord
- `playwright-core` - 浏览器自动化
- `sharp` - 图像处理
- `zod` - Schema 验证

### C. 参考文档
- Moltbot 代码库：`/Users/liuxuedong/projects/moltbot/`
- 架构文档：`docs/architecture-overview.md`
- 核心代码位置：`docs/core-code-locations.md`
- 用户请求流程：`docs/user-request-flow.md`

---

**开始学习之前，请完整阅读本目录架构文档，理解整体结构和依赖关系。**

**Good luck, and happy coding! 🚀**
