# 20 - 内置工具集需求

> **版本**: v1.0
> **最后更新**: 2026-01-29
> **依赖文档**: 18-工具抽象层需求, 19-工具注册与发现需求
> **后续文档**: 21-工具权限控制需求

---

## 1. 需求概述

### 1.1 目标描述

实现**完整的内置工具集**,为 Agent 提供文件操作、命令执行、会话通信、Web 访问等核心能力。

**核心目标:**
- **文件系统**: 读写编辑文件
- **运行时执行**: 执行命令、后台任务
- **会话通信**: 跨会话消息发送
- **Web 工具**: 搜索、抓取网页
- **消息工具**: 跨渠道消息发送
- **其他工具**: 浏览器、画布、定时任务、图片生成

---

## 2. 核心工具集

### 2.1 文件系统工具

#### Read 工具

**功能**: 读取文件内容

**参数**:
```typescript
{
  file_path: string;       // 文件路径
  offset?: number;         // 起始行号
  limit?: number;          // 读取行数
}
```

**返回**:
```
     1→import fs from 'node:fs';
     2→
     3→export function hello() {
     4→  console.log('Hello, World!');
     5→}
```

#### Write 工具

**功能**: 写入文件(覆盖)

**参数**:
```typescript
{
  file_path: string;       // 文件路径
  content: string;         // 文件内容
}
```

#### Edit 工具

**功能**: 精确编辑文件

**参数**:
```typescript
{
  file_path: string;       // 文件路径
  old_string: string;      // 要替换的内容
  new_string: string;      // 新内容
  replace_all?: boolean;   // 是否替换全部
}
```

---

### 2.2 运行时执行工具

#### Exec 工具

**功能**: 执行 Shell 命令

**参数**:
```typescript
{
  command: string;         // 命令
  description?: string;    // 命令描述
  timeout?: number;        // 超时时间(毫秒)
  run_in_background?: boolean;  // 是否后台运行
}
```

**示例**:
```typescript
// 执行命令
{
  command: 'ls -la',
  description: 'List files in current directory'
}

// 后台任务
{
  command: 'npm run build',
  run_in_background: true,
  timeout: 300000  // 5 分钟
}
```

#### Process 工具

**功能**: 管理后台任务

**参数**:
```typescript
{
  action: 'list' | 'stop' | 'output';
  task_id?: string;        // 任务 ID
}
```

---

### 2.3 会话通信工具

#### Sessions List 工具

**功能**: 列出所有会话

**参数**:
```typescript
{
  filter?: 'active' | 'all';
}
```

**返回**:
```json
{
  "sessions": [
    {
      "sessionKey": "telegram:user:123456",
      "label": "Work Chat",
      "lastActive": "2026-01-29T10:00:00Z",
      "messageCount": 42
    }
  ]
}
```

#### Sessions Send 工具

**功能**: 向其他会话发送消息

**参数**:
```typescript
{
  sessionKey?: string;     // 会话 Key
  label?: string;          // 会话标签
  agentId?: string;        // Agent ID
  message: string;         // 消息内容
  timeoutSeconds?: number; // 等待回复超时
}
```

**示例**:
```typescript
// 通过 sessionKey 发送
{
  sessionKey: 'telegram:user:123456',
  message: 'Hello from another session!'
}

// 通过标签发送
{
  label: 'Work Chat',
  message: 'Update complete'
}
```

#### Sessions Spawn 工具

**功能**: 创建子 Agent 会话

**参数**:
```typescript
{
  prompt: string;          // 子 Agent 的初始提示
  thinking?: 'low' | 'medium' | 'high';
  agentId?: string;        // Agent ID
}
```

#### Session Status 工具

**功能**: 查询会话状态

**返回**:
```json
{
  "sessionKey": "telegram:user:123456",
  "agentId": "main",
  "messageCount": 42,
  "status": "active"
}
```

#### Sessions History 工具

**功能**: 查询会话历史

**参数**:
```typescript
{
  sessionKey?: string;
  limit?: number;          // 返回消息数
}
```

---

### 2.4 Web 工具

#### Web Search 工具

**功能**: 网页搜索(Brave Search)

**参数**:
```typescript
{
  query: string;           // 搜索关键词
  count?: number;          // 结果数量(1-10)
  country?: string;        // 国家代码(US, DE, ALL)
  search_lang?: string;    // 语言(en, de, fr)
  freshness?: string;      // 时间范围(pd, pw, pm, py)
}
```

**返回**:
```json
{
  "results": [
    {
      "title": "Example Site",
      "url": "https://example.com",
      "description": "Example description",
      "age": "2 days ago"
    }
  ]
}
```

**配置**:
```json5
{
  tools: {
    web: {
      search: {
        provider: "brave",      // brave, perplexity
        cacheMinutes: 15,
        timeoutSeconds: 10
      }
    }
  }
}
```

#### Web Fetch 工具

**功能**: 抓取网页内容

**参数**:
```typescript
{
  url: string;             // 网页 URL
  prompt?: string;         // 提取提示
}
```

**返回**:
```
URL: https://example.com
Title: Example Site

Content:
This is the main content...
```

**安全**:
- SSRF 防护(阻止内网 IP)
- URL 白名单/黑名单

---

### 2.5 消息工具

#### Message 工具

**功能**: 跨渠道发送消息

**参数**:
```typescript
{
  channel?: string;        // 渠道名称(telegram, whatsapp)
  target?: string;         // 目标用户/群组
  accountId?: string;      // 账号 ID
  message?: string;        // 消息文本
  media?: string;          // 媒体文件路径
  buffer?: string;         // Base64 媒体数据
  replyTo?: string;        // 回复消息 ID
  silent?: boolean;        // 静默发送
}
```

**示例**:
```typescript
// 发送文本消息
{
  channel: 'telegram',
  target: '123456',
  message: 'Hello!'
}

// 发送图片
{
  channel: 'whatsapp',
  target: '+1234567890',
  media: '/path/to/image.jpg',
  caption: 'Check this out'
}
```

---

### 2.6 其他工具

#### Browser 工具

**功能**: 浏览器自动化

**参数**:
```typescript
{
  action: 'navigate' | 'click' | 'type' | 'screenshot';
  url?: string;
  selector?: string;
  text?: string;
}
```

**说明**:
- 支持沙箱浏览器(远程)
- 支持主机浏览器(本地)

#### Canvas 工具

**功能**: 绘制简单图形

**参数**:
```typescript
{
  width: number;
  height: number;
  commands: Array<{
    type: 'rect' | 'circle' | 'text';
    x: number;
    y: number;
    // ...
  }>;
}
```

#### Cron 工具

**功能**: 注册定时任务

**参数**:
```typescript
{
  action: 'add' | 'list' | 'remove';
  schedule?: string;       // Cron 表达式(如 '0 9 * * *')
  prompt?: string;         // 执行的提示
  id?: string;             // 任务 ID
}
```

**示例**:
```typescript
// 每天早上 9 点执行
{
  action: 'add',
  schedule: '0 9 * * *',
  prompt: 'Send daily report'
}
```

#### Gateway 工具

**功能**: Gateway 管理

**参数**:
```typescript
{
  action: 'status' | 'restart';
}
```

#### Nodes 工具

**功能**: 管理移动设备节点

**参数**:
```typescript
{
  action: 'list' | 'screenshot' | 'location';
  nodeId?: string;
}
```

#### Image 工具

**功能**: 图片生成(DALL-E 或其他)

**参数**:
```typescript
{
  prompt: string;          // 图片描述
  size?: '1024x1024' | '1792x1024' | '1024x1792';
}
```

#### Agents List 工具

**功能**: 列出可用 Agent

**返回**:
```json
{
  "agents": [
    {
      "id": "main",
      "name": "主助手",
      "model": "anthropic/claude-sonnet-4-5"
    }
  ]
}
```

---

## 3. 工具创建模式

### 3.1 工具工厂函数

**模式**:

```typescript
export function createMyTool(opts?: {
  config?: MoltbotConfig;
  // ... 其他选项
}): AnyAgentTool {
  return {
    name: 'my_tool',
    description: 'Tool description',
    parameters: MyToolSchema,
    async execute(toolCallId, params, signal, onUpdate) {
      // 1. 参数提取
      const input = readStringParam(params, 'input', { required: true });

      // 2. 业务逻辑
      const result = await doSomething(input);

      // 3. 返回结果
      return jsonResult({ status: 'ok', result });
    }
  };
}
```

### 3.2 参数提取辅助

```typescript
// 字符串参数
const value = readStringParam(params, 'key', { required: true });

// 数字参数
const count = readNumberParam(params, 'count', { integer: true });

// 字符串数组
const items = readStringArrayParam(params, 'items');
```

### 3.3 结果格式化

```typescript
// JSON 结果
return jsonResult({ status: 'ok', data: {...} });

// 图片结果
return await imageResult({
  label: 'screenshot',
  path: '/path/to/image.png',
  base64: base64Data,
  mimeType: 'image/png'
});

// 纯文本
return {
  content: [{ type: 'text', text: 'Operation successful' }]
};
```

---

## 4. 工具集成

### 4.1 Moltbot 工具集

```typescript
export function createMoltbotTools(options?: {
  agentSessionKey?: string;
  agentChannel?: GatewayMessageChannel;
  config?: MoltbotConfig;
  // ...
}): AnyAgentTool[] {
  return [
    createBrowserTool(),
    createCanvasTool(),
    createNodesTool(),
    createCronTool(),
    createMessageTool(),
    createGatewayTool(),
    createAgentsListTool(),
    createSessionsListTool(),
    createSessionsHistoryTool(),
    createSessionsSendTool(),
    createSessionsSpawnTool(),
    createSessionStatusTool(),
    createWebSearchTool(),
    createWebFetchTool(),
    createImageTool(),
    createTtsTool(),
  ].filter(Boolean);
}
```

### 4.2 编码工具集

```typescript
import { codingTools } from '@mariozechner/pi-coding-agent';

// 包含: read, write, edit
const tools = codingTools();
```

### 4.3 全部工具整合

```typescript
export function createMoltbotCodingTools(options) {
  const allTools = [
    ...codingTools(),              // read, write, edit
    createExecTool(),              // exec
    createProcessTool(),           // process
    createApplyPatchTool(),        // apply_patch
    ...createMoltbotTools(options), // Moltbot 特有工具
    ...resolvePluginTools(options), // 插件工具
    ...listChannelAgentTools(options), // 渠道工具
  ];

  return allTools;
}
```

---

## 5. 工具配置

### 5.1 Web 工具配置

```json5
{
  tools: {
    web: {
      search: {
        provider: "brave",          // 搜索提供商
        cacheMinutes: 15,           // 缓存时间
        timeoutSeconds: 10          // 超时时间
      },
      fetch: {
        allowedDomains: ["example.com"],
        blockedDomains: ["malware.com"],
        cacheMinutes: 15,
        timeoutSeconds: 30
      }
    }
  }
}
```

### 5.2 Exec 工具配置

```json5
{
  tools: {
    exec: {
      ask: true,                    // 是否请求用户确认
      security: "auto",             // auto, ask, deny
      timeoutSec: 120,              // 超时时间
      backgroundMs: 5000,           // 后台任务阈值
      safeBins: ["git", "npm"],     // 安全命令白名单
      pathPrepend: ["/usr/local/bin"],
      applyPatch: {
        allowModels: ["anthropic/claude-sonnet-4-5"]
      }
    }
  }
}
```

### 5.3 消息工具配置

```json5
{
  tools: {
    message: {
      enabled: true
    }
  }
}
```

---

**文档完成** ✅
