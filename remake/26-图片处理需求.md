# 26 - 图片处理需求

> **版本**: v1.0
> **最后更新**: 2026-01-29
> **依赖文档**: 25-媒体类型检测需求
> **后续文档**: 27-音视频处理需求

---

## 1. 需求概述

### 1.1 目标描述

实现**图片格式转换、压缩、元数据提取**等处理功能。

**核心目标:**
- **格式转换**: HEIC → JPEG, WebP → PNG
- **尺寸调整**: 缩放、裁剪
- **压缩优化**: 减小文件大小
- **元数据提取**: 尺寸、EXIF 信息

---

## 2. 核心功能

### 2.1 格式转换

**场景**: HEIC 格式转 JPEG(iOS 照片)

```typescript
import sharp from 'sharp';

export async function convertImage(params: {
  input: Buffer;
  format: 'jpeg' | 'png' | 'webp';
  quality?: number;
}): Promise<Buffer> {
  return await sharp(params.input)
    .toFormat(params.format, { quality: params.quality ?? 85 })
    .toBuffer();
}
```

### 2.2 尺寸提取

```typescript
export async function getImageDimensions(buffer: Buffer): Promise<{
  width: number;
  height: number;
}> {
  const metadata = await sharp(buffer).metadata();
  return {
    width: metadata.width ?? 0,
    height: metadata.height ?? 0
  };
}
```

### 2.3 图片压缩

```typescript
export async function compressImage(params: {
  input: Buffer;
  maxWidth?: number;
  maxHeight?: number;
  quality?: number;
}): Promise<Buffer> {
  let pipeline = sharp(params.input);

  // 调整尺寸
  if (params.maxWidth || params.maxHeight) {
    pipeline = pipeline.resize(params.maxWidth, params.maxHeight, {
      fit: 'inside',
      withoutEnlargement: true
    });
  }

  // 压缩质量
  return await pipeline
    .jpeg({ quality: params.quality ?? 80 })
    .toBuffer();
}
```

---

## 3. 图片转换管道

```typescript
export async function processImage(params: {
  buffer: Buffer;
  targetFormat?: 'jpeg' | 'png';
  maxWidth?: number;
  quality?: number;
}): Promise<{
  buffer: Buffer;
  mimeType: string;
  width: number;
  height: number;
}> {
  // 1. 检测原始格式
  const originalMime = await detectMime({ buffer: params.buffer });

  // 2. 转换格式
  let processed = params.buffer;
  if (params.targetFormat) {
    processed = await convertImage({
      input: params.buffer,
      format: params.targetFormat,
      quality: params.quality
    });
  }

  // 3. 调整尺寸
  if (params.maxWidth) {
    processed = await compressImage({
      input: processed,
      maxWidth: params.maxWidth,
      quality: params.quality
    });
  }

  // 4. 提取元数据
  const dimensions = await getImageDimensions(processed);

  return {
    buffer: processed,
    mimeType: `image/${params.targetFormat ?? 'jpeg'}`,
    width: dimensions.width,
    height: dimensions.height
  };
}
```

---

**文档完成** ✅
