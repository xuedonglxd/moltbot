# 23 - 工具安全机制需求

> **版本**: v1.0
> **最后更新**: 2026-01-29
> **依赖文档**: 18-工具抽象层需求, 20-内置工具集需求, 21-工具权限控制需求
> **后续文档**: 24-媒体管道基础需求

---

## 1. 需求概述

### 1.1 目标描述

实现**全面的工具安全机制**,防止工具被滥用或执行危险操作,保障系统和用户数据安全。

**核心目标:**
- **命令执行安全**: 防止危险命令执行
- **网络安全**: 防止 SSRF 攻击
- **沙箱隔离**: 限制工具访问范围
- **用户审批**: 敏感操作需用户确认
- **审计日志**: 记录工具执行历史

---

## 2. 命令执行安全

### 2.1 安全模式

**三级安全模式**:

```typescript
type ExecSecurity = 'deny' | 'allowlist' | 'full';
```

| 模式 | 说明 |
|------|------|
| `deny` | 完全禁用命令执行 |
| `allowlist` | 仅允许白名单命令 |
| `full` | 允许所有命令(不推荐) |

**配置**:

```json5
{
  tools: {
    exec: {
      security: "allowlist",    // 默认 allowlist
      safeBins: ["git", "npm", "pnpm", "node", "python"],
      ask: "on-miss"            // off, on-miss, always
    }
  }
}
```

### 2.2 命令白名单

**定义**: 允许执行的二进制文件列表。

**默认白名单**:

```typescript
const DEFAULT_SAFE_BINS = [
  'git', 'npm', 'pnpm', 'bun', 'node', 'python', 'python3',
  'ls', 'cat', 'grep', 'find', 'sed', 'awk',
  'mkdir', 'rm', 'cp', 'mv', 'touch',
  'curl', 'wget'
];
```

**检查逻辑**:

```typescript
export function requiresExecApproval(params: {
  command: string;
  security: ExecSecurity;
  safeBins: string[];
}): boolean {
  // 完全禁用
  if (params.security === 'deny') {
    return true; // 需要审批(实际会被拒绝)
  }

  // 允许所有
  if (params.security === 'full') {
    return false;
  }

  // 检查白名单
  const binary = extractBinaryName(params.command);
  return !params.safeBins.includes(binary);
}
```

### 2.3 用户审批

**三级审批模式**:

```typescript
type ExecAsk = 'off' | 'on-miss' | 'always';
```

| 模式 | 说明 |
|------|------|
| `off` | 不请求审批,直接拒绝/允许 |
| `on-miss` | 不在白名单时请求审批 |
| `always` | 所有命令都请求审批 |

**审批流程**:

```
Agent 调用 exec 工具
  ↓
检查安全模式
  ├─ deny → 直接拒绝
  ├─ full → 直接允许
  └─ allowlist → 检查白名单
      ├─ 在白名单 → 允许
      └─ 不在白名单 → 检查 ask 模式
          ├─ off → 拒绝
          ├─ on-miss → 请求用户审批
          └─ always → 请求用户审批
```

**审批实现**:

```typescript
export async function requestExecApproval(params: {
  command: string;
  slug: string;
  timeoutMs: number;
}): Promise<{ approved: boolean }> {
  // 1. 通过 Gateway 向用户发送审批请求
  await callGatewayTool({
    method: 'sendApprovalRequest',
    params: {
      slug: params.slug,
      command: params.command,
      timeoutMs: params.timeoutMs
    }
  });

  // 2. 等待用户响应
  const result = await waitForApproval(params.slug, params.timeoutMs);

  return { approved: result.approved };
}
```

### 2.4 审批缓存

**定义**: 用户批准的命令会缓存,避免重复审批。

**存储**:

```json5
// ~/.clawdbot/exec-approvals.json
{
  "allowlist": {
    "sha256:abc123...": {
      "command": "npm install",
      "approvedAt": "2026-01-29T10:00:00Z",
      "usedCount": 5
    }
  }
}
```

**匹配**:

```typescript
export function evaluateShellAllowlist(params: {
  command: string;
  allowlist: Record<string, ApprovalEntry>;
}): { matched: boolean; hash?: string } {
  const hash = crypto
    .createHash('sha256')
    .update(params.command)
    .digest('hex');

  const entry = params.allowlist[`sha256:${hash}`];
  if (entry) {
    return { matched: true, hash };
  }

  return { matched: false };
}
```

---

## 3. 网络安全(SSRF 防护)

### 3.1 SSRF 攻击

**定义**: Server-Side Request Forgery,服务端请求伪造。

**风险**: Agent 可能被诱导访问内网资源(如 `http://localhost`、`http://192.168.1.1`)。

### 3.2 防护策略

**阻止列表**:

```typescript
const BLOCKED_HOSTNAMES = [
  'localhost',
  'local',
  '127.0.0.1',
  '::1',
  '0.0.0.0',
  'metadata.google.internal',  // GCP 元数据服务
  '169.254.169.254',            // AWS/Azure 元数据服务
];

const BLOCKED_IP_RANGES = [
  '10.0.0.0/8',       // 私有网络
  '172.16.0.0/12',    // 私有网络
  '192.168.0.0/16',   // 私有网络
  '127.0.0.0/8',      // 回环地址
  '169.254.0.0/16',   // 链路本地地址
  '::1/128',          // IPv6 回环
  'fc00::/7',         // IPv6 私有网络
];
```

### 3.3 检查流程

```
URL: https://example.com
  ↓
提取 hostname
  ↓
检查是否在阻止列表
  ├─ 是 → 拒绝
  └─ 否 → DNS 解析
      ↓
检查解析的 IP 是否在私有范围
  ├─ 是 → 拒绝
  └─ 否 → 允许访问
      ↓
处理重定向
  ├─ 检查重定向目标
  └─ 重复上述流程
```

### 3.4 实现

```typescript
export async function checkSSRF(url: string): Promise<void> {
  const parsed = new URL(url);
  const hostname = parsed.hostname.toLowerCase();

  // 1. 检查主机名黑名单
  if (BLOCKED_HOSTNAMES.includes(hostname)) {
    throw new Error(`Blocked hostname: ${hostname}`);
  }

  // 2. 检查 IP 地址(字面量)
  if (isIPAddress(hostname)) {
    if (isPrivateIP(hostname)) {
      throw new Error(`Private IP address blocked: ${hostname}`);
    }
    return; // 公网 IP,允许
  }

  // 3. DNS 解析
  const addresses = await dns.lookup(hostname, { all: true });

  for (const addr of addresses) {
    if (isPrivateIP(addr.address)) {
      throw new Error(`Hostname resolves to private IP: ${addr.address}`);
    }
  }
}
```

### 3.5 重定向防护

```typescript
async function handleRedirect(
  response: Response,
  visited: Set<string>
): Promise<Response> {
  if (!response.ok && response.status >= 300 && response.status < 400) {
    const location = response.headers.get('location');
    if (!location) throw new Error('Redirect missing location');

    // 检查重定向目标
    await checkSSRF(location);

    // 防止循环重定向
    if (visited.has(location)) {
      throw new Error('Redirect loop detected');
    }

    visited.add(location);
    return fetch(location);
  }

  return response;
}
```

---

## 4. 沙箱隔离

### 4.1 沙箱模式

**定义**: 限制工具的访问范围,防止误操作或恶意行为。

**配置**:

```json5
{
  tools: {
    sandbox: {
      enabled: true,
      root: "/workspace",        // 沙箱根目录
      tools: {
        allow: ["group:fs"],
        deny: ["exec"]
      }
    }
  }
}
```

### 4.2 文件系统限制

**路径验证**:

```typescript
export function validateSandboxPath(params: {
  path: string;
  sandboxRoot: string;
}): string {
  const resolved = path.resolve(params.path);
  const root = path.resolve(params.sandboxRoot);

  // 检查是否在沙箱内
  if (!resolved.startsWith(root)) {
    throw new Error(`Path outside sandbox: ${params.path}`);
  }

  return resolved;
}
```

**示例**:

```typescript
// 沙箱根目录: /workspace
validateSandboxPath({ path: '/workspace/file.txt', sandboxRoot: '/workspace' });
// ✅ 允许

validateSandboxPath({ path: '/etc/passwd', sandboxRoot: '/workspace' });
// ❌ 拒绝: Path outside sandbox
```

### 4.3 Docker 沙箱

**定义**: 在 Docker 容器中运行命令。

**实现**:

```typescript
export function buildDockerExecArgs(params: {
  containerId: string;
  workdir: string;
  command: string;
  env?: Record<string, string>;
}): string[] {
  const args = ['exec', '-i'];

  // 工作目录
  args.push('-w', params.workdir);

  // 环境变量
  if (params.env) {
    for (const [key, value] of Object.entries(params.env)) {
      args.push('-e', `${key}=${value}`);
    }
  }

  // 容器 ID
  args.push(params.containerId);

  // 命令
  args.push('sh', '-c', params.command);

  return args;
}
```

---

## 5. 中断支持

### 5.1 AbortSignal

**定义**: 允许用户或系统中断正在运行的工具。

**实现**:

```typescript
export async function execute(
  toolCallId: string,
  params: Record<string, unknown>,
  signal?: AbortSignal
): Promise<AgentToolResult<unknown>> {
  // 检查中断
  if (signal?.aborted) {
    throw new Error('Tool execution aborted');
  }

  // 长时间操作
  for (const item of items) {
    if (signal?.aborted) {
      throw new Error('Tool execution aborted');
    }
    await processItem(item);
  }

  return jsonResult({ status: 'ok' });
}
```

### 5.2 后台任务中断

```typescript
export function killSession(sessionId: string): void {
  const session = getSession(sessionId);
  if (!session) return;

  // 发送 SIGTERM
  session.process.kill('SIGTERM');

  // 5 秒后如果未退出,发送 SIGKILL
  setTimeout(() => {
    if (session.process.exitCode === null) {
      session.process.kill('SIGKILL');
    }
  }, 5000);
}
```

---

## 6. 输出限制

### 6.1 输出截断

**定义**: 防止工具输出过大导致内存溢出。

**配置**:

```typescript
const DEFAULT_MAX_OUTPUT = 200_000; // 200K 字符
```

**实现**:

```typescript
export function truncateOutput(
  output: string,
  maxLength: number
): { content: string; truncated: boolean } {
  if (output.length <= maxLength) {
    return { content: output, truncated: false };
  }

  // 保留前 80% 和后 20%
  const keepStart = Math.floor(maxLength * 0.8);
  const keepEnd = maxLength - keepStart - 100; // 留 100 字符给提示

  const truncated = output.slice(0, keepStart) +
    '\n\n[... output truncated ...]\n\n' +
    output.slice(-keepEnd);

  return { content: truncated, truncated: true };
}
```

---

## 7. 审计日志

### 7.1 工具调用日志

**记录内容**:
- 工具名称
- 调用参数
- 执行结果
- 时间戳
- 会话 Key

**实现**:

```typescript
export function logToolExecution(params: {
  toolName: string;
  params: Record<string, unknown>;
  result: AgentToolResult<unknown>;
  sessionKey?: string;
  durationMs: number;
}) {
  const entry = {
    timestamp: new Date().toISOString(),
    toolName: params.toolName,
    params: sanitizeParams(params.params),
    status: params.result.details?.status ?? 'ok',
    durationMs: params.durationMs,
    sessionKey: params.sessionKey
  };

  // 写入日志
  auditLog.write(JSON.stringify(entry) + '\n');
}
```

### 7.2 敏感参数脱敏

```typescript
export function sanitizeParams(
  params: Record<string, unknown>
): Record<string, unknown> {
  const sensitiveKeys = ['password', 'token', 'apiKey', 'secret'];
  const sanitized = { ...params };

  for (const key of Object.keys(sanitized)) {
    if (sensitiveKeys.some(k => key.toLowerCase().includes(k))) {
      sanitized[key] = '[REDACTED]';
    }
  }

  return sanitized;
}
```

---

## 8. 配置示例

### 8.1 严格安全配置

```json5
{
  tools: {
    exec: {
      security: "allowlist",
      ask: "always",
      safeBins: ["git", "npm"],
      timeoutSec: 60
    },
    sandbox: {
      enabled: true,
      root: "/workspace",
      tools: {
        allow: ["group:fs", "group:web"],
        deny: ["exec", "gateway"]
      }
    },
    web: {
      fetch: {
        blockedDomains: ["internal.company.com"],
        timeoutSeconds: 30
      }
    }
  }
}
```

### 8.2 宽松开发配置

```json5
{
  tools: {
    exec: {
      security: "full",
      ask: "off",
      timeoutSec: 300
    },
    sandbox: {
      enabled: false
    }
  }
}
```

---

## 9. 安全最佳实践

### 9.1 生产环境

- 启用 `security: "allowlist"`
- 启用 `ask: "on-miss"` 或 `ask: "always"`
- 启用沙箱模式
- 配置 SSRF 防护
- 定期审计日志

### 9.2 开发环境

- 可使用 `security: "full"`
- 可关闭审批(`ask: "off"`)
- 可关闭沙箱
- 仍应保留 SSRF 防护

### 9.3 多用户环境

- 严格的工具权限控制
- 用户级别的审批配置
- 完整的审计日志
- 会话隔离

---

**文档完成** ✅
