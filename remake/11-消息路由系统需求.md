# 11 - 消息路由系统需求

> **版本**: v1.0
> **最后更新**: 2026-01-29
> **依赖文档**: 07-渠道抽象层需求
> **后续文档**: 12-会话管理需求

---

## 1. 需求概述

### 1.1 目标描述

实现**确定性的消息路由系统**，根据消息来源（渠道、账户、对话）将消息路由到正确的 Agent 和会话，并生成唯一的 Session Key。

**核心目标:**
- **确定性路由**: 相同的消息来源总是路由到相同的 Agent
- **优先级匹配**: 支持多级路由规则，按优先级匹配
- **Session Key 生成**: 为每个唯一的对话生成确定性的 Session Key
- **绑定配置**: 支持通过配置文件自定义路由规则

### 1.2 业务场景

#### 场景 1: 默认路由
**用户操作**: 用户首次在 WhatsApp 发送消息。

**路由逻辑**:
```
1. 检查是否有匹配的绑定规则 → 无
2. 检查渠道默认 Agent → 无
3. 使用系统默认 Agent → "main"
4. 生成 Session Key: "agent:main:whatsapp:dm:<user-id>"
```

#### 场景 2: 群组路由
**用户操作**: 用户在 Discord 群组 #general 发送消息。

**路由逻辑**:
```
1. 检查是否有该群组的绑定 → 有: agents.bindings[guildId]
2. 使用绑定的 Agent → "discord-bot"
3. 生成 Session Key: "agent:discord-bot:discord:group:<guild-id>"
```

#### 场景 3: 多 Agent 路由
**需求**: 不同的联系人路由到不同的 Agent。

**配置**:
```json5
{
  agents: {
    bindings: {
      // Alice 路由到 research agent
      "whatsapp:dm:1234567890@s.whatsapp.net": {
        agentId: "research"
      },

      // Bob 路由到 main agent
      "whatsapp:dm:0987654321@s.whatsapp.net": {
        agentId: "main"
      }
    }
  }
}
```

---

## 2. 核心概念

### 2.1 路由输入

```typescript
interface RouteInput {
  cfg: MoltbotConfig;           // 配置对象
  channel: string;              // 渠道 ID（whatsapp/telegram）
  accountId?: string;           // 账户 ID（多账户场景）
  peer: {                       // 对话对等方
    kind: 'dm' | 'group';       // 对话类型
    id: string;                 // 对话 ID
  };
  guildId?: string;             // Discord Guild ID
  teamId?: string;              // Slack Team ID
}
```

### 2.2 路由输出

```typescript
interface RouteResult {
  agentId: string;              // 目标 Agent ID
  sessionKey: string;           // 会话键
  mainSessionKey: string;       // 主会话键
  channel: string;              // 渠道
  accountId?: string;           // 账户 ID
  matchedBy: string;            // 匹配方式
}
```

### 2.3 路由优先级

**匹配顺序（从高到低）**:
```
1. 精确 Peer 匹配
   - 匹配 channel:peer.kind:peer.id
   - 示例: "whatsapp:dm:1234567890@s.whatsapp.net"

2. Guild 匹配（Discord）
   - 匹配 Discord Guild ID
   - 示例: "discord:guild:123456789"

3. Team 匹配（Slack）
   - 匹配 Slack Team ID
   - 示例: "slack:team:T123456"

4. Account 匹配
   - 匹配 channel:accountId
   - 示例: "telegram:bot-1"

5. Channel 匹配
   - 匹配整个渠道
   - 示例: "whatsapp:*"

6. 默认 Agent
   - agents.list 中标记 default: true 的 Agent
   - 或第一个 Agent
   - 或 "main"
```

### 2.4 Session Key 格式

**DM（私聊）**:
```
agent:<agentId>:<mainKey>
```

**示例**:
```
agent:main:main
```

**Group（群组）**:
```
agent:<agentId>:<channel>:group:<group-id>
```

**示例**:
```
agent:main:whatsapp:group:abc123@g.us
agent:discord-bot:discord:group:987654321
```

**Sub-agent（子 Agent）**:
```
agent:<agentId>:subagent:<uuid>
```

**示例**:
```
agent:main:subagent:550e8400-e29b-41d4-a716-446655440000
```

### 2.5 绑定配置

**格式**:
```json5
{
  agents: {
    bindings: {
      "<binding-key>": {
        agentId: "<agent-id>",
        sessionKey?: "<custom-session-key>" // 可选
      }
    }
  }
}
```

**绑定键格式**:
- Peer: `<channel>:<dm|group>:<peer-id>`
- Guild: `<channel>:guild:<guild-id>`
- Team: `<channel>:team:<team-id>`
- Account: `<channel>:<account-id>`
- Channel: `<channel>:*`

---

## 3. 功能需求

### 3.1 核心功能列表

#### P0 功能

| 功能 ID | 功能名称 | 说明 |
|---------|---------|------|
| **F01** | 路由解析 | resolveAgentRoute() |
| **F02** | Session Key 生成 | 确定性生成会话键 |
| **F03** | 优先级匹配 | 按优先级匹配绑定规则 |
| **F04** | 默认路由 | 未匹配时使用默认 Agent |

#### P1 功能

| 功能 ID | 功能名称 | 说明 |
|---------|---------|------|
| **F05** | 绑定配置 | 通过配置自定义路由规则 |
| **F06** | 路由缓存 | 缓存路由结果，提高性能 |

---

## 4. 架构设计

### 4.1 接口定义

```typescript
export function resolveAgentRoute(input: RouteInput): RouteResult {
  const { cfg, channel, accountId, peer, guildId, teamId } = input;

  // 1. 尝试精确 Peer 匹配
  const peerKey = `${channel}:${peer.kind}:${peer.id}`;
  const peerBinding = cfg.agents?.bindings?.[peerKey];
  if (peerBinding) {
    return {
      agentId: peerBinding.agentId,
      sessionKey: generateSessionKey(peerBinding.agentId, channel, peer),
      mainSessionKey: `agent:${peerBinding.agentId}:main`,
      channel,
      accountId,
      matchedBy: 'peer'
    };
  }

  // 2. 尝试 Guild 匹配
  if (guildId) {
    const guildKey = `${channel}:guild:${guildId}`;
    const guildBinding = cfg.agents?.bindings?.[guildKey];
    if (guildBinding) {
      return {
        agentId: guildBinding.agentId,
        sessionKey: generateSessionKey(guildBinding.agentId, channel, peer),
        mainSessionKey: `agent:${guildBinding.agentId}:main`,
        channel,
        accountId,
        matchedBy: 'guild'
      };
    }
  }

  // 3-6. 其他匹配...（Team、Account、Channel、默认）

  // 最终：使用默认 Agent
  const defaultAgent = findDefaultAgent(cfg);
  return {
    agentId: defaultAgent.id,
    sessionKey: generateSessionKey(defaultAgent.id, channel, peer),
    mainSessionKey: `agent:${defaultAgent.id}:main`,
    channel,
    accountId,
    matchedBy: 'default'
  };
}
```

### 4.2 Session Key 生成

```typescript
function generateSessionKey(
  agentId: string,
  channel: string,
  peer: { kind: 'dm' | 'group'; id: string }
): string {
  if (peer.kind === 'dm') {
    // DM: agent:<agentId>:main
    return `agent:${agentId}:main`;
  } else {
    // Group: agent:<agentId>:<channel>:group:<group-id>
    return `agent:${agentId}:${channel}:group:${peer.id}`;
  }
}
```

---

## 5. 关键实现

### 5.1 参考代码位置

| 功能 | Moltbot 代码位置 |
|------|-----------------|
| 路由解析 | `src/routing/resolve-route.ts` |

---

## 6. 验收标准

### 6.1 功能验收

#### 验收项 1: 路由解析

**测试步骤**:
1. 配置绑定规则
2. 发送测试消息
3. 验证路由到正确的 Agent

**通过标准**:
- 路由结果正确
- Session Key 格式正确

---

**文档完成** ✅
