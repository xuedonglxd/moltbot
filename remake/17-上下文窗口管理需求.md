# 17 - 上下文窗口管理需求

> **版本**: v1.0
> **最后更新**: 2026-01-29
> **依赖文档**: 13-会话压缩需求, 16-Agent执行循环需求
> **后续文档**: 18-工具抽象层需求

---

## 1. 需求概述

### 1.1 目标描述

实现**动态上下文窗口管理**，实时监控 Token 使用，接近限制时自动触发压缩，支持不同提供商的窗口限制差异。

**核心目标:**
- **实时监控**: 实时统计 Token 使用
- **自适应压缩**: 根据窗口大小自适应调整压缩策略
- **提供商差异**: 处理不同模型的窗口限制
- **优雅降级**: 超出限制时优雅处理

---

## 2. 核心概念

### 2.1 上下文窗口守卫

```typescript
export class ContextWindowGuard {
  private currentTokens = 0;
  private readonly limit: number;
  private readonly threshold: number;

  constructor(modelContextLimit: number, threshold = 0.8) {
    this.limit = modelContextLimit;
    this.threshold = threshold;
  }

  update(tokens: number) {
    this.currentTokens = tokens;

    if (this.currentTokens > this.limit * this.threshold) {
      return { shouldCompact: true, usage: this.getUsage() };
    }

    return { shouldCompact: false, usage: this.getUsage() };
  }

  getUsage() {
    return {
      current: this.currentTokens,
      limit: this.limit,
      ratio: this.currentTokens / this.limit
    };
  }
}
```

---

## 3. 关键实现

### 3.1 实现步骤

```typescript
// 在 Agent 执行循环中使用
const guard = new ContextWindowGuard(200000); // Claude 200K

// 每次 LLM 调用后更新
const usage = await callLLM(...);
const check = guard.update(usage.totalTokens);

if (check.shouldCompact) {
  await compactSession(sessionId);
}
```

---

**文档完成** ✅
