# 18 - 工具抽象层需求

> **版本**: v1.0
> **最后更新**: 2026-01-29
> **依赖文档**: 16-Agent执行循环需求, 06-插件系统需求
> **后续文档**: 19-工具注册与发现需求

---

## 1. 需求概述

### 1.1 目标描述

实现**统一的工具抽象接口**,为 Agent 提供丰富的工具能力,包括工具定义、执行、权限控制等。

**核心目标:**
- **工具接口**: 统一的 AgentTool 接口定义
- **Schema 定义**: 基于 TypeBox 的参数 Schema
- **执行模型**: 异步执行,支持中断,支持流式输出
- **权限控制**: 工具策略与权限管理

---

## 2. 核心概念

### 2.1 工具定义

**AgentTool 接口**:

```typescript
interface AgentTool<TParams, TResult> {
  name: string;
  label?: string;
  description: string;
  parameters: TObject; // TypeBox Schema
  execute: (
    toolCallId: string,
    params: TParams,
    signal?: AbortSignal,
    onUpdate?: AgentToolUpdateCallback<TResult>
  ) => Promise<AgentToolResult<TResult>>;
}
```

**字段说明**:
- `name`: 工具唯一名称(如 `exec`、`read`)
- `description`: 工具功能描述(提供给 LLM)
- `parameters`: 参数 Schema(TypeBox 定义)
- `execute`: 工具执行函数

### 2.2 工具执行结果

```typescript
interface AgentToolResult<T> {
  content: Array<
    | { type: "text"; text: string }
    | { type: "image"; data: string; mimeType: string }
  >;
  details?: T;
}
```

**说明**:
- `content`: 返回给 Agent 的内容块(文本 + 图片)
- `details`: 结构化数据(可选)

### 2.3 工具分类

| 分类 | 工具名 | 说明 |
|------|-------|------|
| **文件系统** | `read`, `write`, `edit` | 文件读写编辑 |
| **运行时** | `exec`, `process` | 执行命令、后台任务 |
| **会话管理** | `sessions_list`, `sessions_send` | 跨会话通信 |
| **Web 工具** | `web_search`, `web_fetch` | 网页搜索、抓取 |
| **消息工具** | `message` | 跨渠道消息发送 |
| **其他** | `browser`, `canvas`, `cron` | 浏览器、画布、定时任务 |

---

## 3. 关键实现

### 3.1 实现步骤

#### 步骤 1: 定义工具 Schema

```typescript
import { Type } from '@sinclair/typebox';

const ReadToolSchema = Type.Object({
  file_path: Type.String({ description: '文件路径' }),
  offset: Type.Optional(Type.Number()),
  limit: Type.Optional(Type.Number()),
});
```

#### 步骤 2: 实现工具执行函数

```typescript
export function createReadTool(): AgentTool<ReadParams, ReadResult> {
  return {
    name: 'read',
    description: '读取文件内容',
    parameters: ReadToolSchema,
    async execute(toolCallId, params, signal) {
      // 读取文件
      const content = await fs.readFile(params.file_path, 'utf-8');

      // 返回结果
      return {
        content: [{ type: 'text', text: content }],
        details: { path: params.file_path, lines: content.split('\n').length }
      };
    }
  };
}
```

#### 步骤 3: 注册工具

```typescript
// 在 createMoltbotCodingTools 中注册
const tools = [
  createReadTool(),
  createWriteTool(),
  createEditTool(),
  createExecTool(),
  // ...
];
```

#### 步骤 4: 工具适配器

**转换为 LLM 工具格式**:

```typescript
export function toToolDefinitions(tools: AnyAgentTool[]): ToolDefinition[] {
  return tools.map((tool) => ({
    name: tool.name,
    label: tool.label ?? tool.name,
    description: tool.description,
    parameters: tool.parameters,
    execute: async (toolCallId, params, onUpdate, ctx, signal) => {
      try {
        return await tool.execute(toolCallId, params, signal, onUpdate);
      } catch (err) {
        // 错误处理
        return jsonResult({
          status: 'error',
          tool: tool.name,
          error: err.message
        });
      }
    }
  }));
}
```

---

## 4. 工具策略

### 4.1 工具分组

```typescript
const TOOL_GROUPS = {
  'group:fs': ['read', 'write', 'edit', 'apply_patch'],
  'group:runtime': ['exec', 'process'],
  'group:web': ['web_search', 'web_fetch'],
  'group:sessions': ['sessions_list', 'sessions_send', 'sessions_spawn'],
  'group:messaging': ['message'],
};
```

### 4.2 工具策略配置

```json5
{
  tools: {
    profile: "coding",  // minimal, coding, messaging, full
    allow: ["group:fs", "group:runtime"],
    deny: ["exec"]
  }
}
```

**预设配置**:

| Profile | 允许工具 |
|---------|---------|
| `minimal` | `session_status` |
| `coding` | 文件系统 + 运行时 + 会话管理 |
| `messaging` | 消息工具 + 会话查询 |
| `full` | 全部工具 |

### 4.3 权限检查

```typescript
export function isToolAllowedByPolicy(
  toolName: string,
  policy: ToolPolicy
): boolean {
  const normalized = normalizeToolName(toolName);

  // 检查 deny 列表
  if (policy.deny?.includes(normalized)) {
    return false;
  }

  // 检查 allow 列表
  if (policy.allow && policy.allow.length > 0) {
    const expanded = expandToolGroups(policy.allow);
    return expanded.includes(normalized);
  }

  // 默认允许
  return true;
}
```

---

## 5. 工具执行

### 5.1 执行流程

```
Agent 调用工具
  ↓
权限检查
  ↓
参数验证
  ↓
执行工具
  ├─ 成功 → 返回结果
  └─ 失败 → 返回错误
  ↓
记录到会话历史
```

### 5.2 错误处理

```typescript
try {
  return await tool.execute(toolCallId, params, signal, onUpdate);
} catch (err) {
  if (signal?.aborted) throw err; // 中断信号,直接抛出

  // 记录错误
  logError(`[tools] ${tool.name} failed: ${err.message}`);

  // 返回错误结果
  return jsonResult({
    status: 'error',
    tool: tool.name,
    error: err.message
  });
}
```

### 5.3 中断支持

```typescript
async function execute(toolCallId, params, signal) {
  // 检查中断
  if (signal?.aborted) {
    throw new Error('Tool execution aborted');
  }

  // 长时间操作,定期检查中断
  for (const item of items) {
    if (signal?.aborted) break;
    await processItem(item);
  }
}
```

---

## 6. 工具结果格式

### 6.1 纯文本结果

```typescript
return {
  content: [{ type: 'text', text: 'File written successfully' }],
  details: { path: '/path/to/file', size: 1234 }
};
```

### 6.2 图片结果

```typescript
return {
  content: [
    { type: 'text', text: 'MEDIA:/path/to/image.png' },
    { type: 'image', data: base64Data, mimeType: 'image/png' }
  ],
  details: { path: '/path/to/image.png', width: 800, height: 600 }
};
```

### 6.3 JSON 结果

```typescript
export function jsonResult(payload: unknown): AgentToolResult<unknown> {
  return {
    content: [
      {
        type: 'text',
        text: JSON.stringify(payload, null, 2)
      }
    ],
    details: payload
  };
}
```

---

## 7. 特殊工具

### 7.1 客户端工具

**定义**:
- 工具在客户端执行(如浏览器、移动端)
- Agent 调用工具后返回 `pending` 状态
- 客户端执行完成后通过 WebSocket 返回结果

**示例**:

```typescript
export function toClientToolDefinitions(
  tools: ClientToolDefinition[]
): ToolDefinition[] {
  return tools.map(tool => ({
    name: tool.function.name,
    description: tool.function.description,
    parameters: tool.function.parameters,
    execute: async (toolCallId, params) => {
      // 返回 pending,实际执行由客户端完成
      return jsonResult({
        status: 'pending',
        tool: tool.function.name,
        message: 'Tool execution delegated to client'
      });
    }
  }));
}
```

### 7.2 插件工具

**注册方式**:

```typescript
// 插件中注册工具
api.registerTool({
  name: 'my_tool',
  description: 'Custom tool',
  parameters: Type.Object({
    input: Type.String()
  }),
  async execute(toolCallId, params) {
    // 自定义逻辑
    return jsonResult({ result: 'ok' });
  }
});
```

---

**文档完成** ✅
