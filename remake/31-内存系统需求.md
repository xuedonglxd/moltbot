# 31 - 内存系统需求

> **版本**: v1.0
> **最后更新**: 2026-01-29
> **依赖文档**: 12-会话管理需求
> **后续文档**: 32-设备节点需求

---

## 1. 需求概述

### 1.1 目标描述

实现**长期记忆存储和检索**，Agent 可以记住和查询历史信息。

**核心目标:**
- **向量存储**: 使用向量数据库(LanceDB)
- **语义搜索**: 基于语义相似度检索
- **记忆管理**: 添加、删除、更新记忆

---

## 2. 核心概念

### 2.1 记忆条目

```typescript
type MemoryEntry = {
  id: string;
  content: string;           // 记忆内容
  embedding: number[];       // 向量嵌入
  metadata: {
    sessionKey?: string;
    timestamp: string;
    tags?: string[];
  };
};
```

### 2.2 记忆工具

**Memory Search 工具**:

```typescript
{
  name: 'memory_search',
  description: 'Search for relevant memories',
  parameters: {
    query: string;
    limit?: number;
  }
}
```

**Memory Get 工具**:

```typescript
{
  name: 'memory_get',
  description: 'Get memory by ID',
  parameters: {
    id: string;
  }
}
```

---

## 3. 实现

### 3.1 向量嵌入

```typescript
export async function generateEmbedding(text: string): Promise<number[]> {
  // 调用嵌入模型(OpenAI, etc.)
  const response = await fetch('https://api.openai.com/v1/embeddings', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${API_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      model: 'text-embedding-ada-002',
      input: text
    })
  });

  const data = await response.json();
  return data.data[0].embedding;
}
```

### 3.2 语义搜索

```typescript
import { connect } from 'vectordb';

export async function searchMemories(params: {
  query: string;
  limit: number;
}): Promise<MemoryEntry[]> {
  const db = await connect('~/.clawdbot/memory');
  const table = await db.openTable('memories');

  // 生成查询向量
  const queryEmbedding = await generateEmbedding(params.query);

  // 搜索
  const results = await table
    .search(queryEmbedding)
    .limit(params.limit)
    .execute();

  return results;
}
```

---

**文档完成** ✅
