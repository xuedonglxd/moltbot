# 22 - 渠道特定工具需求

> **版本**: v1.0
> **最后更新**: 2026-01-29
> **依赖文档**: 18-工具抽象层需求, 07-渠道抽象层需求
> **后续文档**: 23-工具安全机制需求

---

## 1. 需求概述

### 1.1 目标描述

实现**渠道特定的 Agent 工具**,为不同消息渠道提供专属的操作能力,如 Telegram 投票、WhatsApp 联系人卡片、Discord 权限管理等。

**核心目标:**
- **渠道绑定**: 工具仅在对应渠道会话中可用
- **动态加载**: 根据当前会话渠道动态加载工具
- **统一接口**: 使用统一的工具接口封装渠道 API
- **权限控制**: 支持渠道级别的工具权限配置

---

## 2. 核心概念

### 2.1 渠道工具定义

```typescript
type ChannelAgentTool = {
  channel: string;       // 渠道标识(如 'telegram', 'whatsapp')
  tool: AnyAgentTool;    // 工具实现
};
```

### 2.2 工具分类

| 渠道 | 工具名 | 功能 |
|------|--------|------|
| **Telegram** | `telegram_send_poll` | 发送投票 |
| | `telegram_pin_message` | 置顶消息 |
| | `telegram_edit_message` | 编辑消息 |
| | `telegram_delete_message` | 删除消息 |
| | `telegram_react` | 添加反应 |
| | `telegram_send_sticker` | 发送贴纸 |
| **WhatsApp** | `whatsapp_react` | 添加反应 |
| | `whatsapp_send_contact` | 发送联系人 |
| | `whatsapp_send_location` | 发送位置 |
| **Discord** | `discord_add_role` | 添加角色 |
| | `discord_remove_role` | 移除角色 |
| | `discord_kick_member` | 踢出成员 |
| | `discord_ban_member` | 封禁成员 |
| **Slack** | `slack_add_reaction` | 添加反应 |
| | `slack_pin_message` | 置顶消息 |

---

## 3. 关键实现

### 3.1 实现步骤

#### 步骤 1: 渠道插件提供工具

```typescript
// 在渠道插件中注册工具
export const telegramChannelPlugin: ChannelPlugin = {
  id: 'telegram',
  name: 'Telegram',

  agentTools: (params: { cfg?: MoltbotConfig }) => {
    return [
      createTelegramSendPollTool(params.cfg),
      createTelegramPinMessageTool(params.cfg),
      createTelegramEditMessageTool(params.cfg),
      createTelegramDeleteMessageTool(params.cfg),
      createTelegramReactTool(params.cfg),
      createTelegramSendStickerTool(params.cfg),
    ];
  }
};
```

#### 步骤 2: 工具发现

```typescript
export function listChannelAgentTools(params: {
  cfg?: MoltbotConfig;
}): ChannelAgentTool[] {
  const tools: ChannelAgentTool[] = [];

  // 遍历所有渠道插件
  for (const plugin of listChannelPlugins()) {
    const entry = plugin.agentTools;
    if (!entry) continue;

    // 调用工具工厂
    const resolved = typeof entry === 'function' ? entry(params) : entry;
    if (Array.isArray(resolved)) {
      tools.push(...resolved);
    }
  }

  return tools;
}
```

#### 步骤 3: 工具集成

```typescript
export function createMoltbotCodingTools(options?: {
  messageProvider?: string;
  config?: MoltbotConfig;
  // ...
}) {
  // 加载渠道工具
  const channelTools = listChannelAgentTools({
    cfg: options?.config
  });

  // 过滤当前渠道的工具
  const activeChannelTools = options?.messageProvider
    ? channelTools.filter(t => t.channel === options.messageProvider)
    : [];

  return [
    ...coreTools,
    ...moltbotTools,
    ...activeChannelTools.map(t => t.tool)
  ];
}
```

---

## 4. Telegram 工具

### 4.1 Send Poll 工具

**功能**: 发送投票

**参数**:
```typescript
{
  chatId: string | number;
  question: string;
  options: string[];         // 投票选项
  isAnonymous?: boolean;     // 是否匿名
  allowMultipleAnswers?: boolean;
  accountId?: string;
}
```

**示例**:
```typescript
{
  chatId: '-100123456789',
  question: 'Which framework do you prefer?',
  options: ['React', 'Vue', 'Angular'],
  isAnonymous: true
}
```

### 4.2 Pin Message 工具

**功能**: 置顶消息

**参数**:
```typescript
{
  chatId: string | number;
  messageId: number;
  accountId?: string;
}
```

### 4.3 Edit Message 工具

**功能**: 编辑已发送的消息

**参数**:
```typescript
{
  chatId: string | number;
  messageId: number;
  text: string;
  accountId?: string;
}
```

### 4.4 Delete Message 工具

**功能**: 删除消息

**参数**:
```typescript
{
  chatId: string | number;
  messageId: number;
  accountId?: string;
}
```

### 4.5 React 工具

**功能**: 添加消息反应

**参数**:
```typescript
{
  action: 'react';
  chatId: string | number;
  messageId: number;
  emoji: string;             // 反应 emoji
  remove?: boolean;          // 是否移除反应
  accountId?: string;
}
```

**配置**:
```json5
{
  channels: {
    telegram: {
      reactionLevel: "minimal",  // none, minimal, extensive
      actions: {
        reactions: true
      }
    }
  }
}
```

### 4.6 Send Sticker 工具

**功能**: 发送贴纸

**参数**:
```typescript
{
  chatId: string | number;
  query: string;             // 贴纸搜索关键词
  accountId?: string;
}
```

---

## 5. WhatsApp 工具

### 5.1 React 工具

**功能**: 添加消息反应

**参数**:
```typescript
{
  action: 'react';
  chatJid: string;           // 聊天 JID
  messageId: string;         // 消息 ID
  emoji: string;
  remove?: boolean;
  participant?: string;      // 群组消息发送者
  fromMe?: boolean;
  accountId?: string;
}
```

**实现**:
```typescript
export async function handleWhatsAppAction(
  params: Record<string, unknown>,
  cfg: MoltbotConfig
): Promise<AgentToolResult<unknown>> {
  const action = readStringParam(params, 'action', { required: true });

  if (action === 'react') {
    const chatJid = readStringParam(params, 'chatJid', { required: true });
    const messageId = readStringParam(params, 'messageId', { required: true });
    const { emoji, remove } = readReactionParams(params);

    await sendReactionWhatsApp(chatJid, messageId, remove ? '' : emoji, {
      accountId: params.accountId as string | undefined
    });

    return jsonResult({ ok: true, emoji });
  }

  throw new Error(`Unsupported WhatsApp action: ${action}`);
}
```

### 5.2 Send Contact 工具

**功能**: 发送联系人卡片

**参数**:
```typescript
{
  chatJid: string;
  name: string;
  phoneNumber: string;
  accountId?: string;
}
```

### 5.3 Send Location 工具

**功能**: 发送位置

**参数**:
```typescript
{
  chatJid: string;
  latitude: number;
  longitude: number;
  name?: string;
  accountId?: string;
}
```

---

## 6. Discord 工具

### 6.1 Add Role 工具

**功能**: 给成员添加角色

**参数**:
```typescript
{
  action: 'addRole';
  guildId: string;
  userId: string;
  roleId: string;
  accountId?: string;
}
```

### 6.2 Remove Role 工具

**功能**: 移除成员角色

**参数**:
```typescript
{
  action: 'removeRole';
  guildId: string;
  userId: string;
  roleId: string;
  accountId?: string;
}
```

### 6.3 Kick Member 工具

**功能**: 踢出成员

**参数**:
```typescript
{
  action: 'kickMember';
  guildId: string;
  userId: string;
  reason?: string;
  accountId?: string;
}
```

### 6.4 Ban Member 工具

**功能**: 封禁成员

**参数**:
```typescript
{
  action: 'banMember';
  guildId: string;
  userId: string;
  deleteMessageDays?: number;
  reason?: string;
  accountId?: string;
}
```

---

## 7. Slack 工具

### 7.1 Add Reaction 工具

**功能**: 添加反应

**参数**:
```typescript
{
  action: 'addReaction';
  channel: string;
  timestamp: string;         // 消息时间戳
  name: string;              // 反应名称(如 'thumbsup')
  accountId?: string;
}
```

### 7.2 Pin Message 工具

**功能**: 置顶消息

**参数**:
```typescript
{
  action: 'pinMessage';
  channel: string;
  timestamp: string;
  accountId?: string;
}
```

---

## 8. 工具权限配置

### 8.1 渠道级权限

```json5
{
  channels: {
    telegram: {
      actions: {
        reactions: true,
        polls: true,
        pinning: true,
        editing: true,
        deletion: false  // 禁用删除
      }
    },
    whatsapp: {
      actions: {
        reactions: true
      }
    }
  }
}
```

### 8.2 动态权限检查

```typescript
export async function handleTelegramAction(
  params: Record<string, unknown>,
  cfg: MoltbotConfig
): Promise<AgentToolResult<unknown>> {
  const action = readStringParam(params, 'action', { required: true });

  // 权限检查
  const isActionEnabled = createActionGate(cfg.channels?.telegram?.actions);

  if (action === 'react') {
    if (!isActionEnabled('reactions')) {
      throw new Error('Telegram reactions are disabled');
    }

    // 执行操作...
  }
}
```

---

## 9. 消息工具提示

### 9.1 动态提示

**定义**: 在系统提示中告知 Agent 当前渠道支持哪些工具。

**实现**:
```typescript
export function resolveChannelMessageToolHints(params: {
  cfg?: MoltbotConfig;
  channel?: string | null;
  accountId?: string | null;
}): string[] {
  const channelId = normalizeAnyChannelId(params.channel);
  if (!channelId) return [];

  const dock = getChannelDock(channelId);
  const resolve = dock?.agentPrompt?.messageToolHints;
  if (!resolve) return [];

  return (resolve({ cfg: params.cfg, accountId: params.accountId }) ?? [])
    .map(entry => entry.trim())
    .filter(Boolean);
}
```

**使用**:
```typescript
const hints = resolveChannelMessageToolHints({
  cfg: config,
  channel: 'telegram',
  accountId: '123456'
});

// hints: [
//   'Use telegram_send_poll to send polls',
//   'Use telegram_pin_message to pin messages'
// ]
```

### 9.2 系统提示集成

```
You are connected to Telegram.

Available channel-specific tools:
- telegram_send_poll: Send polls
- telegram_pin_message: Pin messages
- telegram_react: React to messages with emoji
```

---

## 10. 工具实现模式

### 10.1 统一动作处理

```typescript
export async function handleChannelAction(
  channel: string,
  params: Record<string, unknown>,
  cfg: MoltbotConfig
): Promise<AgentToolResult<unknown>> {
  switch (channel) {
    case 'telegram':
      return handleTelegramAction(params, cfg);
    case 'whatsapp':
      return handleWhatsAppAction(params, cfg);
    case 'discord':
      return handleDiscordAction(params, cfg);
    case 'slack':
      return handleSlackAction(params, cfg);
    default:
      throw new Error(`Unsupported channel: ${channel}`);
  }
}
```

### 10.2 权限检查辅助

```typescript
export function createActionGate<T extends Record<string, boolean | undefined>>(
  actions: T | undefined
): (key: keyof T, defaultValue?: boolean) => boolean {
  return (key, defaultValue = true) => {
    const value = actions?.[key];
    if (value === undefined) return defaultValue;
    return value !== false;
  };
}
```

---

**文档完成** ✅
