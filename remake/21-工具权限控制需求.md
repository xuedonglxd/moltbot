# 21 - 工具权限控制需求

> **版本**: v1.0
> **最后更新**: 2026-01-29
> **依赖文档**: 18-工具抽象层需求, 20-内置工具集需求
> **后续文档**: 22-渠道特定工具需求

---

## 1. 需求概述

### 1.1 目标描述

实现**细粒度的工具权限控制**,通过配置策略和上下文信息控制 Agent 可以使用哪些工具,保障系统安全性。

**核心目标:**
- **分层策略**: 全局配置 + Agent 配置 + 会话级配置
- **Allow/Deny 列表**: 支持白名单和黑名单
- **工具组**: 通过工具组批量管理权限
- **上下文感知**: 根据会话类型、渠道、沙箱状态调整策略

---

## 2. 核心概念

### 2.1 工具策略

**结构**:

```typescript
type SandboxToolPolicy = {
  allow?: string[];  // 白名单(为空表示允许全部)
  deny?: string[];   // 黑名单
};
```

**规则**:
1. **Deny 优先**: 如果工具在 `deny` 列表,直接拒绝
2. **Allow 过滤**: 如果 `allow` 列表存在,只允许列表中的工具
3. **默认允许**: 如果 `allow` 为空且不在 `deny` 中,允许

**示例**:

```json5
{
  tools: {
    allow: ["group:fs", "group:runtime"],
    deny: ["exec"]
  }
}
```

解释:
- 允许文件系统工具组(`read`, `write`, `edit`)
- 允许运行时工具组(但排除 `exec`)
- `exec` 被显式拒绝

### 2.2 工具组

**内置工具组**:

```typescript
const TOOL_GROUPS = {
  'group:fs': ['read', 'write', 'edit', 'apply_patch'],
  'group:runtime': ['exec', 'process'],
  'group:web': ['web_search', 'web_fetch'],
  'group:sessions': ['sessions_list', 'sessions_send', 'sessions_spawn'],
  'group:messaging': ['message'],
  'group:memory': ['memory_search', 'memory_get'],
  'group:ui': ['browser', 'canvas'],
  'group:automation': ['cron', 'gateway'],
  'group:nodes': ['nodes'],
  'group:moltbot': [
    'browser', 'canvas', 'nodes', 'cron', 'message', 'gateway',
    'agents_list', 'sessions_list', 'sessions_history', 'sessions_send',
    'sessions_spawn', 'session_status', 'memory_search', 'memory_get',
    'web_search', 'web_fetch', 'image'
  ]
};
```

**扩展示例**:

```json5
{
  tools: {
    allow: ["group:fs"]
  }
}

// 等价于
{
  tools: {
    allow: ["read", "write", "edit", "apply_patch"]
  }
}
```

### 2.3 通配符支持

**语法**:
- `*`: 匹配所有工具
- `tool_*`: 前缀匹配
- `*_action`: 后缀匹配

**示例**:

```json5
{
  tools: {
    allow: ["*"],              // 允许所有
    deny: ["sessions_*"]       // 拒绝 sessions_ 开头的工具
  }
}
```

---

## 3. 策略层级

### 3.1 分层结构

```
默认策略(Default)
  ↓
全局配置(Global: tools.*)
  ↓
Agent 配置(Agent: agents.list[].tools.*)
  ↓
渠道配置(Channel: telegram.tools.*)
  ↓
群组配置(Group: groups[].tools.*)
  ↓
子 Agent 配置(Subagent: tools.subagents.tools.*)
```

**优先级**: 下层覆盖上层。

### 3.2 全局配置

```json5
{
  tools: {
    profile: "coding",         // 预设配置
    allow: ["group:fs", "group:runtime"],
    deny: ["gateway"]
  }
}
```

### 3.3 Agent 配置

```json5
{
  agents: {
    list: [
      {
        id: "main",
        tools: {
          allow: ["*"],
          deny: []
        }
      },
      {
        id: "limited",
        tools: {
          profile: "minimal"
        }
      }
    ]
  }
}
```

### 3.4 渠道配置

```json5
{
  telegram: {
    tools: {
      allow: ["group:messaging", "sessions_list"]
    }
  }
}
```

### 3.5 群组配置

**定义**: 对特定群组/频道设置工具策略。

```json5
{
  groups: [
    {
      id: "telegram:group:123456",
      tools: {
        deny: ["exec", "process"]  // 群组中禁用命令执行
      }
    }
  ]
}
```

### 3.6 子 Agent 策略

**定义**: `sessions_spawn` 创建的子 Agent 默认受限。

**默认拒绝列表**:

```typescript
const DEFAULT_SUBAGENT_TOOL_DENY = [
  // 会话管理(防止递归创建子 Agent)
  'sessions_list',
  'sessions_history',
  'sessions_send',
  'sessions_spawn',
  // 系统管理
  'gateway',
  'agents_list',
  // 交互式设置
  'whatsapp_login',
  // 状态/调度
  'session_status',
  'cron',
  // 记忆系统
  'memory_search',
  'memory_get',
];
```

**配置**:

```json5
{
  tools: {
    subagents: {
      tools: {
        deny: ["web_search"],  // 额外拒绝
        allow: ["group:fs"]    // 仅允许文件系统工具
      }
    }
  }
}
```

---

## 4. 预设 Profile

### 4.1 内置 Profile

```typescript
const TOOL_PROFILES = {
  minimal: {
    allow: ['session_status']
  },
  coding: {
    allow: ['group:fs', 'group:runtime', 'group:sessions', 'group:memory', 'image']
  },
  messaging: {
    allow: [
      'group:messaging',
      'sessions_list',
      'sessions_history',
      'sessions_send',
      'session_status'
    ]
  },
  full: {}  // 允许所有
};
```

### 4.2 使用 Profile

```json5
{
  tools: {
    profile: "coding"  // 使用预设配置
  }
}
```

**Profile + 自定义**:

```json5
{
  tools: {
    profile: "coding",
    deny: ["exec"]  // 在 coding 基础上额外拒绝 exec
  }
}
```

---

## 5. 权限检查实现

### 5.1 策略编译

```typescript
type CompiledPattern =
  | { kind: 'all' }                  // * 匹配所有
  | { kind: 'exact'; value: string } // 精确匹配
  | { kind: 'regex'; value: RegExp }; // 通配符转正则

function compilePattern(pattern: string): CompiledPattern {
  const normalized = normalizeToolName(pattern);
  if (normalized === '*') return { kind: 'all' };
  if (!normalized.includes('*')) {
    return { kind: 'exact', value: normalized };
  }

  // 将通配符转为正则
  const escaped = normalized.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  return {
    kind: 'regex',
    value: new RegExp(`^${escaped.replaceAll('\\*', '.*')}$`)
  };
}
```

### 5.2 匹配检查

```typescript
function matchesAny(name: string, patterns: CompiledPattern[]): boolean {
  for (const pattern of patterns) {
    if (pattern.kind === 'all') return true;
    if (pattern.kind === 'exact' && name === pattern.value) return true;
    if (pattern.kind === 'regex' && pattern.value.test(name)) return true;
  }
  return false;
}
```

### 5.3 权限判断

```typescript
export function isToolAllowed(
  policy: SandboxToolPolicy,
  name: string
): boolean {
  const normalized = normalizeToolName(name);

  // 1. 检查 deny 列表
  const deny = compilePatterns(policy.deny);
  if (matchesAny(normalized, deny)) return false;

  // 2. 检查 allow 列表
  const allow = compilePatterns(policy.allow);
  if (allow.length === 0) return true; // 无白名单,默认允许
  return matchesAny(normalized, allow);
}
```

### 5.4 批量过滤

```typescript
export function filterToolsByPolicy(
  tools: AnyAgentTool[],
  policy?: SandboxToolPolicy
): AnyAgentTool[] {
  if (!policy) return tools;

  return tools.filter(tool => isToolAllowed(policy, tool.name));
}
```

---

## 6. 策略解析

### 6.1 解析全局 + Agent 配置

```typescript
export function resolveEffectiveToolPolicy(params: {
  config?: MoltbotConfig;
  agentId?: string;
}): SandboxToolPolicy | undefined {
  const cfg = params.config;
  const agentCfg = cfg && params.agentId
    ? resolveAgentConfig(cfg, params.agentId)
    : undefined;

  // Agent 配置优先
  const agentAllow = agentCfg?.tools?.allow;
  const agentDeny = agentCfg?.tools?.deny;

  // 全局配置
  const globalAllow = cfg?.tools?.allow;
  const globalDeny = cfg?.tools?.deny;

  const allow = Array.isArray(agentAllow) ? agentAllow : globalAllow;
  const deny = Array.isArray(agentDeny) ? agentDeny : globalDeny;

  if (!allow && !deny) return undefined;
  return { allow, deny };
}
```

### 6.2 解析群组配置

```typescript
export function resolveGroupToolPolicy(params: {
  config?: MoltbotConfig;
  groupId?: string;
  channel?: string;
}): SandboxToolPolicy | undefined {
  const cfg = params.config;
  if (!cfg || !params.groupId) return undefined;

  // 查找匹配的群组配置
  const group = cfg.groups?.find(g => g.id === params.groupId);
  if (!group?.tools) return undefined;

  return {
    allow: group.tools.allow,
    deny: group.tools.deny
  };
}
```

### 6.3 合并多层策略

```typescript
export function resolveFinalToolPolicy(params: {
  config?: MoltbotConfig;
  agentId?: string;
  sessionKey?: string;
  groupId?: string;
  channel?: string;
  isSubagent?: boolean;
}): SandboxToolPolicy | undefined {
  const policies: SandboxToolPolicy[] = [];

  // 1. 全局 + Agent 策略
  const base = resolveEffectiveToolPolicy({
    config: params.config,
    agentId: params.agentId
  });
  if (base) policies.push(base);

  // 2. 群组策略
  const group = resolveGroupToolPolicy({
    config: params.config,
    groupId: params.groupId,
    channel: params.channel
  });
  if (group) policies.push(group);

  // 3. 子 Agent 策略
  if (params.isSubagent) {
    const subagent = resolveSubagentToolPolicy(params.config);
    policies.push(subagent);
  }

  // 合并所有策略
  return mergePolicies(policies);
}
```

---

## 7. 沙箱模式

### 7.1 沙箱工具策略

**默认限制**:

```typescript
const DEFAULT_SANDBOX_DENY = [
  'gateway',       // 系统管理
  'cron',          // 定时任务
  'nodes',         // 设备节点
];

const DEFAULT_SANDBOX_ALLOW = [
  'group:fs',      // 文件系统
  'group:runtime', // 命令执行
  'session_status' // 会话状态
];
```

**配置**:

```json5
{
  tools: {
    sandbox: {
      tools: {
        allow: ["group:fs"],
        deny: ["exec"]
      }
    }
  }
}
```

### 7.2 沙箱检测

```typescript
const isSandboxed = !!options?.sandbox;

const toolPolicy = isSandboxed
  ? resolveSandboxToolPolicy(config)
  : resolveEffectiveToolPolicy({ config, agentId });
```

---

## 8. 应用工具策略

### 8.1 在工具创建时应用

```typescript
export function createMoltbotCodingTools(options) {
  // 1. 创建所有工具
  const allTools = [...coreTools, ...moltbotTools, ...pluginTools];

  // 2. 解析策略
  const policy = resolveFinalToolPolicy({
    config: options?.config,
    agentId: options?.agentId,
    sessionKey: options?.sessionKey,
    groupId: options?.groupId,
    isSubagent: isSubagentSessionKey(options?.sessionKey)
  });

  // 3. 过滤工具
  return filterToolsByPolicy(allTools, policy);
}
```

### 8.2 在 Agent 运行时应用

```typescript
const tools = createMoltbotCodingTools({
  config: cfg,
  agentId: 'main',
  sessionKey: sessionKey,
  groupId: groupId,
  sandbox: sandboxContext
});

// tools 已经根据策略过滤
```

---

**文档完成** ✅
