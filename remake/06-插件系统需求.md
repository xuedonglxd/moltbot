# 06 - 插件系统需求

> **版本**: v1.0
> **最后更新**: 2026-01-29
> **依赖文档**: 01-配置系统需求, 04-Gateway基础架构需求
> **后续文档**: 07-渠道抽象层需求

---

## 1. 需求概述

### 1.1 目标描述

实现一个**可扩展的插件系统**，允许通过插件动态扩展系统功能，包括新的消息渠道、AI 提供商、工具、内存系统等，无需修改核心代码。

**核心目标:**
- **动态加载**: 在 Gateway 启动时动态发现和加载插件
- **热插拔**: 支持插件的启用/禁用（部分支持热加载）
- **隔离性**: 插件与核心代码隔离，插件错误不影响核心
- **标准化接口**: 定义清晰的插件 API 和生命周期

### 1.2 业务场景

#### 场景 1: 安装新渠道插件
**用户操作**: 用户想使用 Matrix 协议。

**步骤**:
```bash
# 1. 安装插件
npm install @moltbot/channel-matrix

# 2. 配置插件
moltbot config set plugins.entries.matrix.enabled true

# 3. 重启 Gateway（或热重载）
moltbot gateway restart
```

**系统行为**:
1. Gateway 启动时扫描 `node_modules/@moltbot/` 目录
2. 发现 `channel-matrix` 插件
3. 读取插件的 `package.json` 元数据
4. 加载插件的入口文件
5. 注册 Matrix 渠道到渠道管理器

#### 场景 2: 扩展 AI 提供商
**用户操作**: 用户想使用自定义的 AI 提供商。

**插件代码**:
```typescript
// my-custom-provider-plugin/index.ts
export default {
  name: 'my-custom-provider',
  provider: {
    id: 'custom-ai',
    name: 'Custom AI Provider',
    createClient: (config) => {
      // 返回 AI 客户端实现
    }
  }
};
```

#### 场景 3: 扩展工具
**用户操作**: 用户想添加自定义工具。

**插件代码**:
```typescript
// my-tool-plugin/index.ts
export default {
  name: 'my-tool',
  tools: [
    {
      name: 'custom_api_call',
      description: 'Call my custom API',
      schema: { /* JSON Schema */ },
      handler: async (params) => {
        // 工具实现
      }
    }
  ]
};
```

### 1.3 用户价值

- **可扩展性**: 无需修改核心代码即可添加新功能
- **社区生态**: 第三方开发者可以贡献插件
- **模块化**: 功能模块化，按需加载

---

## 2. 核心概念

### 2.1 插件定义

**插件**: 一个 npm 包，包含插件元数据和实现代码。

**插件结构**:
```
@moltbot/channel-matrix/
├── package.json          # 插件元数据
├── index.ts              # 插件入口
└── ...                   # 其他实现代码
```

**package.json 示例**:
```json
{
  "name": "@moltbot/channel-matrix",
  "version": "1.0.0",
  "moltbot": {
    "extensions": ["./index.ts"],
    "channel": {
      "id": "matrix",
      "name": "Matrix",
      "supportsGroups": true
    }
  }
}
```

### 2.2 插件类型

#### 类型 1: 渠道插件
**功能**: 添加新的消息渠道。

**接口**:
```typescript
interface ChannelPlugin {
  id: string;
  name: string;
  start: (config: ChannelConfig) => Promise<void>;
  stop: () => Promise<void>;
  sendMessage: (params: SendParams) => Promise<void>;
}
```

#### 类型 2: 提供商插件
**功能**: 添加新的 AI 提供商。

**接口**:
```typescript
interface ProviderPlugin {
  id: string;
  name: string;
  createClient: (config: ProviderConfig) => AIClient;
}
```

#### 类型 3: 工具插件
**功能**: 添加新的 Agent 工具。

**接口**:
```typescript
interface ToolPlugin {
  tools: Array<{
    name: string;
    description: string;
    schema: JSONSchema;
    handler: (params: unknown) => Promise<unknown>;
  }>;
}
```

#### 类型 4: 内存插件
**功能**: 替换默认的内存系统实现。

**接口**:
```typescript
interface MemoryPlugin {
  createMemoryProvider: () => MemoryProvider;
}
```

### 2.3 插件生命周期

```
1. 发现 (Discovery)
   - 扫描 node_modules/@moltbot/
   - 读取 package.json 元数据

2. 加载 (Load)
   - 动态导入插件模块 (jiti)
   - 验证插件接口

3. 注册 (Register)
   - 注册渠道/提供商/工具
   - 更新系统注册表

4. 启用 (Enable)
   - 调用插件的启动函数
   - 开始使用插件功能

5. 禁用 (Disable)
   - 调用插件的停止函数
   - 从注册表移除

6. 卸载 (Unload)
   - 清理插件资源
   - 释放内存
```

### 2.4 插件发现

**扫描路径**:
1. `node_modules/@moltbot/*` - 官方插件
2. `node_modules/@*/moltbot-*` - 第三方插件
3. `config.plugins.load.paths` - 自定义路径

**发现逻辑**:
```typescript
function discoverPlugins(): PluginManifest[] {
  const plugins: PluginManifest[] = [];

  // 扫描 @moltbot 命名空间
  for (const dir of fs.readdirSync('node_modules/@moltbot')) {
    const pkgPath = `node_modules/@moltbot/${dir}/package.json`;
    const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf-8'));

    if (pkg.moltbot) {
      plugins.push({
        name: pkg.name,
        version: pkg.version,
        metadata: pkg.moltbot
      });
    }
  }

  return plugins;
}
```

### 2.5 插件隔离

**隔离机制**:
- **进程隔离**: 不支持（性能考虑）
- **错误隔离**: try-catch 包裹插件调用
- **状态隔离**: 插件有独立的配置命名空间

**错误处理**:
```typescript
async function loadPlugin(manifest: PluginManifest) {
  try {
    const module = await import(manifest.entryPath);
    return module.default;
  } catch (err) {
    log.error(`Failed to load plugin ${manifest.name}:`, err);
    return null; // 插件加载失败，不影响其他插件
  }
}
```

---

## 3. 功能需求

### 3.1 核心功能列表

#### P0 功能

| 功能 ID | 功能名称 | 说明 |
|---------|---------|------|
| **F01** | 插件发现 | 扫描并发现可用插件 |
| **F02** | 插件加载 | 动态加载插件模块 |
| **F03** | 插件注册 | 注册插件到系统 |
| **F04** | 错误隔离 | 插件错误不影响核心 |

#### P1 功能

| 功能 ID | 功能名称 | 说明 |
|---------|---------|------|
| **F05** | 插件配置 | 管理插件的配置 |
| **F06** | 插件启用/禁用 | 控制插件的启用状态 |
| **F07** | 插件版本管理 | 管理插件版本和依赖 |

---

## 4. 架构设计

### 4.1 接口定义

#### 接口 1: PluginManifest

```typescript
interface PluginManifest {
  name: string;              // 插件名称
  version: string;           // 插件版本
  entryPath: string;         // 入口文件路径
  metadata: {
    extensions: string[];    // 扩展入口列表
    channel?: {              // 渠道元数据
      id: string;
      name: string;
      supportsGroups?: boolean;
    };
    provider?: {             // 提供商元数据
      id: string;
      name: string;
    };
  };
}
```

#### 接口 2: Plugin

```typescript
interface Plugin {
  name: string;
  version?: string;

  // 渠道插件
  channel?: ChannelPlugin;

  // 提供商插件
  provider?: ProviderPlugin;

  // 工具插件
  tools?: ToolPlugin[];

  // 内存插件
  memory?: MemoryPlugin;

  // 生命周期钩子
  onLoad?: () => Promise<void>;
  onUnload?: () => Promise<void>;
}
```

---

## 5. 关键实现

### 5.1 实现步骤

#### 步骤 1: 插件发现

```typescript
// src/gateway/server-plugins.ts
export async function loadGatewayPlugins(
  cfg: MoltbotConfig
): Promise<PluginServicesHandle> {
  // 1. 发现插件
  const manifests = discoverPlugins();

  // 2. 过滤禁用的插件
  const enabled = manifests.filter(m =>
    cfg.plugins?.entries?.[m.name]?.enabled !== false
  );

  // 3. 加载插件
  const plugins: Plugin[] = [];
  for (const manifest of enabled) {
    try {
      const plugin = await loadPlugin(manifest);
      if (plugin) plugins.push(plugin);
    } catch (err) {
      log.error(`Failed to load plugin ${manifest.name}:`, err);
    }
  }

  // 4. 注册插件
  const handle = registerPlugins(plugins);

  return handle;
}
```

#### 步骤 2: 插件注册

```typescript
function registerPlugins(plugins: Plugin[]): PluginServicesHandle {
  const channelRegistry = new Map<string, ChannelPlugin>();
  const providerRegistry = new Map<string, ProviderPlugin>();

  for (const plugin of plugins) {
    // 注册渠道
    if (plugin.channel) {
      channelRegistry.set(plugin.channel.id, plugin.channel);
    }

    // 注册提供商
    if (plugin.provider) {
      providerRegistry.set(plugin.provider.id, plugin.provider);
    }

    // 注册工具
    if (plugin.tools) {
      for (const tool of plugin.tools) {
        toolRegistry.register(tool);
      }
    }
  }

  return {
    channels: channelRegistry,
    providers: providerRegistry,
  };
}
```

### 5.2 参考代码位置

| 功能 | Moltbot 代码位置 |
|------|-----------------|
| 插件加载 | `src/gateway/server-plugins.ts` |
| 渠道插件 | `src/channels/plugins/` |

---

## 6. 验收标准

### 6.1 功能验收

#### 验收项 1: 插件发现

**测试步骤**:
1. 安装测试插件
2. 启动 Gateway
3. 验证插件被发现

**通过标准**:
- 插件出现在插件列表中

#### 验收项 2: 插件加载

**测试步骤**:
1. 启用插件
2. 重启 Gateway
3. 验证插件功能可用

**通过标准**:
- 插件功能正常工作

---

**文档完成** ✅
